# 📘 範本設計完整指南

## 🎯 目標
設計一個 Word 範本，讓系統能自動將 Planning 頁面的章節內容填入，並保留格式。

---

## 📋 第一步：了解可用的變數

### 資料結構
系統會傳遞以下資料給範本：

```javascript
{
  chapters: [
    {
      title: "壹、專案需求建置及服務",  // 章節標題
      sections: [                        // 子章節陣列
        {
          title: "一、專案總起及需求背景說明",  // 子章節標題
          content: "這裡是內容..."              // 子章節內容
        },
        {
          title: "二、專案主要建置服務項目規劃",
          content: "這裡是內容..."
        }
      ]
    },
    {
      title: "貳、另一個章節",
      sections: [...]
    }
  ]
}
```

### 可用變數

| 變數 | 說明 | 範例 |
|------|------|------|
| `{title}` | 章節或子章節標題 | 壹、專案需求建置及服務 |
| `{content}` | 子章節內容 | 詳細的說明文字... |
| `{#chapters}...{/chapters}` | 循環所有章節 | - |
| `{#sections}...{/sections}` | 循環當前章節的所有子章節 | - |

---

## 📝 第二步：在 Word 中創建範本

### 方法 A：手動在 Word 中創建（推薦）

#### 1. 打開 Word，創建新文檔

#### 2. 輸入基本結構

```
服務企劃書
═══════════════════════════════════

📋 目  錄
─────────────────────────────────

{#chapters}
{title}

  {#sections}
  {title}

  {/sections}

{/chapters}

─────────────────────────────────


═══════════════════════════════════
詳細內容
═══════════════════════════════════


{#chapters}
{title}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  {#sections}
  ▸ {title}
  ─────────────────────────────

  {content}

  {/sections}

{/chapters}


═══════════════════════════════════
報告結束
═══════════════════════════════════
```

#### 3. 設定格式

**選中「📋 目  錄」文字**：
- 字體：微軟正黑體或標楷體
- 大小：18pt
- 粗體：✓
- 顏色：紅色 #FA4028
- 對齊：置中

**選中第一個 `{title}`（在 {#chapters} 下面的）**：
- 字體：微軟正黑體
- 大小：14pt
- 粗體：✓
- 顏色：黑色

**選中第二個 `{title}`（在 {#sections} 下面的，前面有空格的）**：
- 字體：微軟正黑體
- 大小：12pt
- 粗體：否
- 顏色：灰色 #666666
- **重要**：確保前面有 2-4 個空格以產生縮排效果

**選中詳細內容區域的 `{title}`（在 {#chapters} 下的）**：
- 字體：微軟正黑體
- 大小：20pt
- 粗體：✓
- 顏色：紅色 #FA4028

**選中詳細內容區域的子章節 `{title}`（▸ 後面的）**：
- 字體：微軟正黑體
- 大小：16pt
- 粗體：✓
- 顏色：黑色
- 縮排：左邊 1cm

**選中 `{content}`**：
- 字體：微軟正黑體
- 大小：12pt
- 粗體：否
- 顏色：黑色
- 行距：1.5 倍
- 縮排：左邊 1cm

#### 4. 儲存範本
- 檔案 → 另存為
- 格式選擇：**Word 文檔 (.docx)**
- 檔名：例如「服務企劃範本」

---

### 方法 B：使用腳本自動生成（進階）

如果你想用程式生成，可以修改 `create-template-v2.js` 腳本。

---

## 🎨 第三步：進階格式技巧

### 1. 添加目錄點線（....）

**選中目錄中的 `{title}` 這一行**：
1. 在 `{title}` 後面按 **Tab 鍵**
2. 輸入一些佔位符文字（例如「頁碼」）
3. 選中整行
4. 點擊「格式」→「定位點」（或「段落」→「定位點」）
5. 設定：
   - 對齊方式：**右對齊**
   - 前置字元：**點線**（....）
   - 位置：17cm（或頁面右邊界）
6. 點擊「設定」→「確定」

**效果**：
```
壹、專案需求建置及服務....................................頁碼
```

### 2. 添加分頁

在需要分頁的地方：
- 插入 → 分隔符號 → 分頁符號
- 或按 **Ctrl + Enter**

### 3. 添加頁首/頁尾

1. 插入 → 頁首與頁尾
2. 輸入文字或添加頁碼
3. 設定格式

### 4. 使用樣式（推薦）

建立自定義樣式可以確保格式一致：

1. 選中格式化好的 `{title}`
2. 在「樣式」面板點擊「新增樣式」
3. 命名（例如「章節標題」）
4. 其他相同類型的標題直接套用此樣式

---

## 🔍 第四步：特殊語法說明

### 循環語法

```
{#chapters}
  這裡會重複顯示每個章節
  可以使用 {title} 來顯示當前章節的標題

  {#sections}
    這裡會重複顯示當前章節的每個子章節
    可以使用 {title} 和 {content}
  {/sections}

{/chapters}
```

### 條件語法（進階）

```
{#content}
  {content}
{/content}
{^content}
  （此章節暫無內容）
{/content}
```
- `{#content}...{/content}`：如果有內容就顯示
- `{^content}...{/content}`：如果沒有內容就顯示

### 注意事項

1. **循環標記必須成對**：`{#xxx}` 和 `{/xxx}` 必須配對
2. **縮排用空格**：不要用 Tab，因為 Tab 可能被解析為定位點
3. **標記區分大小寫**：`{Title}` 和 `{title}` 不同
4. **保持格式**：標記本身的格式會套用到填入的內容

---

## 📤 第五步：上傳範本到系統

### 1. 進入 Templates 頁面
```
http://localhost:3000/dashboard/templates
```

### 2. 雙擊資料夾卡片
- 雙擊「ALL_RESOURCES」或其他自訂資料夾
- 會彈出上傳對話框

### 3. 填寫資訊並上傳
| 欄位 | 內容 |
|------|------|
| 範本名稱 | 服務企劃範本 |
| 分類 | 政府標案 |
| 描述 | 帶目錄的服務企劃書範本 |
| Word 檔案 | 選擇剛才儲存的 .docx 檔案 |

### 4. 點擊「確認上傳」

系統會：
1. 上傳文件到雲端儲存
2. 自動開啟 OnlyOffice 編輯器
3. 你可以在編輯器中進一步調整

### 5. 保存範本
- 在 OnlyOffice 編輯器中按 **Ctrl+S** 保存
- 這會觸發回調，將範本路徑更新到資料庫

---

## 🧪 第六步：測試範本

### 1. 進入 Planning 頁面
```
http://localhost:3000/dashboard/[專案ID]/planning
```

### 2. 確保有章節資料
- 應該能看到「CHAPTER 1」、「SECTION 1.1」等

### 3. 選擇範本
- 在工具列的範本下拉選單中選擇你的範本
- 點擊「預覽」按鈕

### 4. 檢查結果
- 系統會生成填好的文檔並在 Microsoft Office Online 中顯示
- 檢查：
  - ✓ 章節標題是否正確
  - ✓ 子章節是否顯示在章節下方
  - ✓ 子章節是否有縮排
  - ✓ 格式是否正確（顏色、大小、粗體）
  - ✓ 目錄是否有點線（如果有設定）

---

## 🎓 範例範本

### 簡單範本（適合初學者）

```
服務企劃書
═══════════════════════

{#chapters}
【{title}】

{#sections}
  ■ {title}

  {content}

{/sections}

{/chapters}

═══════════════════════
報告結束
```

### 複雜範本（有目錄）

```
═════════════════════════════════════
服務企劃書
═════════════════════════════════════


📋 目  錄
─────────────────────────────────────

{#chapters}
{title}	頁碼

  {#sections}
  {title}

  {/sections}

{/chapters}

─────────────────────────────────────


═════════════════════════════════════
第一部分：專案規劃
═════════════════════════════════════

{#chapters}

【{title}】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

{#sections}

  ▸ {title}
  ─────────────────────────────────

  {content}


{/sections}

{/chapters}


═════════════════════════════════════
報告結束
═════════════════════════════════════
```

---

## 💡 常見問題

### Q1：標記沒有被替換，直接顯示了？
**A**：可能是：
1. 標記拼寫錯誤（檢查大小寫）
2. 循環標記沒有配對
3. 範本沒有正確上傳

### Q2：子章節沒有縮排？
**A**：
1. 在 Word 中選中子章節的 `{title}` 行
2. 使用「格式」→「段落」→「縮排」設定左側縮排（例如 1cm）
3. 或在 `{title}` 前面加 2-4 個空格

### Q3：格式沒有套用？
**A**：確保格式是套用在**標記本身**，不是填入後的內容。系統會將標記的格式套用到填入的內容。

### Q4：目錄點線沒有顯示？
**A**：
1. 確保使用了 Tab 而不是空格
2. 確保設定了「定位點」的「前置字元」為「點線」
3. 定位點位置要設定在頁面右邊界附近（例如 17cm）

### Q5：如何添加圖片或表格？
**A**：直接在範本中插入圖片或表格即可。如果要讓內容區域包含圖片，需要：
1. 確保資料庫的 `content` 欄位包含圖片的 base64 或 URL
2. 或使用 docxtemplater 的圖片模組（進階）

### Q6：如何添加頁碼？
**A**：
1. 插入 → 頁首與頁尾
2. 插入 → 頁碼
3. 選擇樣式和位置
4. Word 會自動為每頁添加頁碼

### Q7：循環標記可以嵌套嗎？
**A**：可以！就像範本中的 `{#chapters}...{#sections}...{/sections}...{/chapters}`

---

## 🎯 設計建議

### 1. 保持簡潔
- 不要過度設計，保持閱讀性
- 使用一致的格式體系

### 2. 考慮列印
- 使用適當的邊界（上下左右至少 2cm）
- 字體大小不要太小（內文至少 12pt）

### 3. 使用標準字體
- 微軟正黑體（無襯線，現代感）
- 標楷體（有襯線，正式感）
- 新細明體（傳統，正式文書）

### 4. 顏色使用
- 標題可以使用品牌色（例如 #FA4028）
- 內文使用黑色
- 次要資訊使用灰色

### 5. 層次分明
- 使用不同的字體大小區分層級
- 標題：20pt
- 子標題：16pt
- 內文：12pt

---

## 🔧 偵錯技巧

### 查看原始資料結構

訪問診斷 API：
```
http://localhost:3000/api/debug/check-sections?projectId=[專案ID]
```

會顯示：
- 章節數量
- 子章節數量
- 層級關係
- 孤立的章節（有 parent_id 但找不到父章節）

### 查看範本是否可下載

訪問診斷 API：
```
http://localhost:3000/api/debug/check-template?templateId=[範本ID]
```

會顯示：
- 範本資訊
- 檔案是否存在
- 檔案大小
- 下載是否成功

---

## 📚 更多資源

- [docxtemplater 官方文檔](https://docxtemplater.com/docs/get-started/)
- [Word 樣式指南](https://support.microsoft.com/zh-tw/office/word)

---

**祝你設計出完美的範本！** 🎉

如果有任何問題，隨時告訴我！
