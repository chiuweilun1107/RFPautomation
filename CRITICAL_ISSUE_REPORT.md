# 🚨 嚴重問題報告：77.5% 標案缺少截止日期

**發現時間**：2026-01-28 14:40
**嚴重程度**：HIGH（影響核心功能）

---

## 📊 問題概述

### **統計資料**

```
總標案數：346 筆
├── 有截止日期：78 筆（22.5%）✅
└── 缺少截止日期：268 筆（77.5%）❌
```

**這表示超過 3/4 的標案無法正確判斷是否已截止！**

---

## 🔍 問題證據

### **案例：彰化縣永靖鄉衛生所標案**

| 來源 | 發布日期 | 截止日期 | 狀態 |
|------|----------|----------|------|
| AceBidX 網站 | 2026-01-05 | **2026-01-22 09:00** ✅ | 公開招標 |
| 資料庫 | 2026-01-05 | **NULL** ❌ | 招標中 |

**URL**: https://acebidx.com/zh-TW/docs/tender/id/febfc72f-e10c-438f-b3cb-c7a9254a5053

**問題**：
1. 網站上明明有截止日期（2026-01-22）
2. 但資料庫中是 NULL
3. 這個標案已經過期 6 天，但系統仍顯示「招標中」

---

## 🎯 根本原因

### **n8n 工作流的資料抓取有問題**

可能的原因：

#### **1. AceBidX API 回傳格式問題**

AceBidX 可能使用不同的欄位名稱或格式：
- `deadline` vs `deadline_date`
- `bidding_deadline` vs `submission_deadline`
- 時間格式不一致

#### **2. n8n 工作流的解析邏輯錯誤**

- n8n 的 JSON 解析節點可能沒有正確對應欄位
- 資料映射時遺漏了 `deadline_date` 欄位
- 或者 `deadline_date` 被映射到錯誤的欄位

#### **3. AceBidX 網站延遲提供截止日期**

- 標案剛發布時可能沒有截止日期
- 後續才補上截止日期
- 但 n8n 沒有更新機制

---

## 💥 影響範圍

### **功能影響**

1. ❌ **狀態篩選不準確**
   - 「已截止」篩選器只能找到 23 筆
   - 實際上應該有更多已過期標案

2. ❌ **自動化更新失效**
   - 268 筆標案永遠不會被標記為「已截止」
   - 因為 `deadline_date = NULL`

3. ❌ **用戶體驗差**
   - 用戶看到「招標中」但實際已截止
   - 浪費時間準備已過期的標案

### **資料完整性**

```
有效資料率：22.5% ❌
缺失資料：77.5%
```

這已經嚴重影響系統的可用性。

---

## 🛠️ 解決方案

### **方案 1：修正 n8n 工作流（治本）** ⭐

#### **步驟 1：檢查 n8n 工作流**

1. 登入 n8n：http://localhost:5678
2. 找到「AceBidX 標案抓取」工作流
3. 檢查 HTTP Request 節點的回應資料
4. 確認 `deadline_date` 欄位的來源

#### **步驟 2：修正資料映射**

在 n8n 的「Set Node」或「Supabase Insert」節點中：

**目前可能的映射**（錯誤）：
```json
{
  "title": "{{ $json.title }}",
  "publish_date": "{{ $json.publishDate }}",
  "deadline_date": null  // ❌ 寫死為 null
}
```

**應該改為**（正確）：
```json
{
  "title": "{{ $json.title }}",
  "publish_date": "{{ $json.publishDate }}",
  "deadline_date": "{{ $json.deadline || $json.deadlineDate || $json.biddingDeadline }}"
}
```

#### **步驟 3：測試並重新抓取**

1. 修改後執行工作流測試
2. 檢查新抓取的標案是否有 `deadline_date`
3. 如果正確，重新抓取所有標案

---

### **方案 2：批量更新現有標案（治標）**

創建一個腳本，從 AceBidX API 重新抓取所有標案的 `deadline_date`。

**優點**：
- 快速修復現有資料
- 不需要等待 n8n 重新抓取

**缺點**：
- 需要大量 API 請求
- 如果 n8n 工作流不修正，未來新標案仍有問題

---

### **方案 3：定期更新機制（補充）**

設定定期任務，重新抓取標案的最新資料：

1. 每天檢查 `deadline_date = NULL` 的標案
2. 從 AceBidX 重新抓取這些標案的資料
3. 更新 `deadline_date`

---

## 🚀 立即行動計劃

### **第一步：診斷 n8n 工作流（今天）**

```
1. 登入 n8n
2. 檢查工作流配置
3. 找出 deadline_date 為何是 NULL
4. 修正資料映射
```

### **第二步：批量更新現有資料（今天）**

```
1. 創建批量更新腳本
2. 從 AceBidX 重新抓取 268 筆標案的 deadline_date
3. 更新資料庫
```

### **第三步：驗證修復（今天）**

```
1. 執行 check-tender-status.js
2. 確認沒有 deadline_date 的標案數量減少
3. 前端測試：「已截止」篩選器應該顯示更多標案
```

---

## 📝 需要的資訊

為了修復這個問題，我需要：

### **1. n8n 工作流的詳細配置**

- 工作流 JSON 檔案
- 或 n8n Dashboard 的截圖

### **2. AceBidX API 的回應範例**

- HTTP Request 節點的實際回應資料
- 確認欄位名稱和格式

### **3. 確認修復優先級**

- 是否立即修復？
- 是否需要批量更新現有資料？

---

## 🎯 預期結果

修復後：

```
總標案數：346 筆
├── 有截止日期：~300 筆（~87%）✅
└── 缺少截止日期：~46 筆（~13%）
    └── 這些可能是網站上真的沒有提供截止日期
```

「已截止」篩選器應該顯示：
```
目前：23 筆 ❌
修復後：~100-150 筆 ✅（根據實際過期數量）
```

---

## 💡 建議

1. **立即修正 n8n 工作流**（最重要）
2. **批量更新現有資料**（補救）
3. **設定定期更新機制**（預防）
4. **監控資料完整性**（持續）

---

**下一步**：請協助提供 n8n 工作流的配置，讓我可以找出具體的問題點並提供修正方案。

或者，您希望我先創建批量更新腳本，立即修復現有資料？
