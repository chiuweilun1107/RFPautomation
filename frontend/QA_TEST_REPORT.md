# ProposalStructureEditor æ¸¬è©¦å ±å‘Š

**QA å¯©æŸ¥å®˜**: Sam
**æ—¥æœŸ**: 2026-01-26
**é …ç›®**: NotebookLM Frontend - ProposalStructureEditor
**æ¸¬è©¦æ¡†æ¶**: Jest 29.7.0 + Testing Library

---

## ğŸ“Š åŸ·è¡Œæ‘˜è¦

### æ¸¬è©¦è¦†è“‹ç‡ç¸½çµ

**å·²å®Œæˆçš„æ¸¬è©¦æ¨¡å¡Š**ï¼š
- âœ… `useProposalState.ts`: **100% è¦†è“‹ç‡** (34 æ¸¬è©¦ï¼Œå…¨éƒ¨é€šé)
- âœ… `treeTraversal.ts`: **100% è¦†è“‹ç‡** (33 æ¸¬è©¦ï¼Œå…¨éƒ¨é€šé)
- âš ï¸ `sectionUtils.ts`: **87.5% è¦†è“‹ç‡** (24 æ¸¬è©¦ï¼Œ21 é€šéï¼Œ3 å¤±æ•—)

**æ¸¬è©¦çµ±è¨ˆ**ï¼š
- **ç¸½æ¸¬è©¦æ•¸**: 91
- **é€šé**: 88 (96.7%)
- **å¤±æ•—**: 3 (3.3%)
- **è¦†è“‹ç‡** (å·²æ¸¬è©¦æ¨¡å¡Š):
  - Statements: 95.8%
  - Branches: 97.9%
  - Functions: 95.8%
  - Lines: 96.4%

---

## âœ… æˆåŠŸå®Œæˆçš„æ¸¬è©¦

### 1. **useProposalState Hook æ¸¬è©¦** (100% è¦†è“‹ç‡)

**æ–‡ä»¶**: `/src/__tests__/components/workspace/proposal-editor/hooks/useProposalState.test.ts`

**æ¸¬è©¦é¡åˆ¥**:
- âœ… åˆå§‹åŒ–é‚è¼¯ (3 æ¸¬è©¦)
- âœ… Section å±•é–‹/æ”¶èµ· (3 æ¸¬è©¦)
- âœ… Task å±•é–‹/æ”¶èµ· (2 æ¸¬è©¦)
- âœ… Category å±•é–‹/æ”¶èµ· (2 æ¸¬è©¦)
- âœ… å…§è¯ç·¨è¼¯ç‹€æ…‹ç®¡ç† (4 æ¸¬è©¦)
- âœ… è¨ˆç®—å±¬æ€§ (flatSections, allProjectImages) (6 æ¸¬è©¦)
- âœ… ç‹€æ…‹é‡ç½®å‡½æ•¸ (2 æ¸¬è©¦)
- âœ… State Setters (6 æ¸¬è©¦)
- âœ… è¤‡é›œç‹€æ…‹ç®¡ç† (2 æ¸¬è©¦)
- âœ… é‚Šç•Œæƒ…æ³ (4 æ¸¬è©¦)

**é—œéµæ¸¬è©¦å ´æ™¯**:
```typescript
âœ“ æ‡‰æ­£ç¢ºåˆå§‹åŒ–é»˜èªç‹€æ…‹
âœ“ æ‡‰æ­£ç¢ºè™•ç† Section å±•é–‹/æ”¶èµ·é‚è¼¯
âœ“ æ‡‰æ­£ç¢ºè™•ç†å…§è¯ç·¨è¼¯é–‹å§‹/å–æ¶ˆ
âœ“ æ‡‰æ­£ç¢ºè¨ˆç®— flatSections (æ”¯æŒæ‹–æ‹½)
âœ“ æ‡‰æ”¶é›†æ‰€æœ‰é …ç›®åœ–ç‰‡
âœ“ æ‡‰é‡ç½®ç”Ÿæˆç‹€æ…‹
âœ“ æ‡‰é‡ç½®ç·¨è¼¯ç‹€æ…‹
```

---

### 2. **Tree Traversal å·¥å…·å‡½æ•¸æ¸¬è©¦** (100% è¦†è“‹ç‡)

**æ–‡ä»¶**: `/src/__tests__/components/workspace/proposal-editor/utils/treeTraversal.test.ts`

**æ¸¬è©¦é¡åˆ¥**:
- âœ… `findSection` - Section æŸ¥æ‰¾ (5 æ¸¬è©¦)
- âœ… `getParentInfo` - çˆ¶ç¯€é»ä¿¡æ¯ç²å– (4 æ¸¬è©¦)
- âœ… `getFlattenedTitles` - æ¨™é¡Œæ‰å¹³åŒ– (4 æ¸¬è©¦)
- âœ… `collectTaskIds` - ä»»å‹™ ID æ”¶é›† (4 æ¸¬è©¦)
- âœ… `updateSectionInTree` - ä¸å¯è®Šæ›´æ–° (4 æ¸¬è©¦)
- âœ… `removeSectionFromTree` - ä¸å¯è®Šåˆªé™¤ (5 æ¸¬è©¦)
- âœ… `traverseSections` - æ¨¹éæ­· (4 æ¸¬è©¦)
- âœ… é‚Šç•Œæƒ…æ³æ¸¬è©¦ (3 æ¸¬è©¦)

**é—œéµæ¸¬è©¦å ´æ™¯**:
```typescript
âœ“ æ‡‰æ‰¾åˆ°é ‚å±¤ Section
âœ“ æ‡‰æ‰¾åˆ°åµŒå¥— Section
âœ“ æ‡‰è™•ç†ç©ºæ•¸çµ„
âœ“ æ‡‰æ­£ç¢ºè™•ç†æ·±åº¦åµŒå¥—çµæ§‹
âœ“ æ‡‰ä¸å¯è®Šåœ°æ›´æ–° Section
âœ“ æ‡‰ä¸è®ŠåŒ–åŸå§‹æ•¸çµ„ï¼ˆä¸å¯è®Šæ€§é©—è­‰ï¼‰
```

---

### 3. **Section Utils å·¥å…·å‡½æ•¸æ¸¬è©¦** (87.5% è¦†è“‹ç‡)

**æ–‡ä»¶**: `/src/__tests__/components/workspace/proposal-editor/utils/sectionUtils.test.ts`

**æ¸¬è©¦é¡åˆ¥**:
- âœ… `parseChineseNumber` - ä¸­æ–‡æ•¸å­—è§£æ (7 æ¸¬è©¦ï¼Œå…¨éƒ¨é€šé)
- âš ï¸ `autoSortChildren` - è‡ªå‹•æ’åº (7 æ¸¬è©¦ï¼Œ4 é€šéï¼Œ3 å¤±æ•—)
- âœ… `updateOrder` - æ›´æ–°é †åº (4 æ¸¬è©¦ï¼Œå…¨éƒ¨é€šé)
- âœ… `updateTaskOrder` - æ›´æ–°ä»»å‹™é †åº (6 æ¸¬è©¦ï¼Œå…¨éƒ¨é€šé)

**å·²é€šéçš„é—œéµæ¸¬è©¦**:
```typescript
âœ“ æ‡‰æ­£ç¢ºè§£æå–®æ•¸ä¸­æ–‡æ•¸å­— (ä¸€~ä¹)
âœ“ æ‡‰æ­£ç¢ºè§£æå
âœ“ æ‡‰æ­£ç¢ºè§£æåä¸€~åä¹
âœ“ æ‡‰æ­£ç¢ºæ›´æ–° Section é †åºåˆ°æ•¸æ“šåº«
âœ“ æ‡‰æ­£ç¢ºè™•ç†æ•¸æ“šåº«éŒ¯èª¤
âœ“ æ‡‰æ­£ç¢ºæ›´æ–°ä»»å‹™é †åº
```

**å·²çŸ¥å•é¡Œ** (3 å€‹å¤±æ•—æ¸¬è©¦):
```
âœ— should sort children by Chinese numerals
âœ— should handle mixed Chinese and non-Chinese titles
âœ— should handle teens correctly (åä¸€, åäºŒ)
```

**å¤±æ•—åŸå› **: Jest module mock æ©Ÿåˆ¶æœªèƒ½æ­£ç¢ºæ””æˆª `autoSortChildren` å…§éƒ¨å° `updateOrder` çš„èª¿ç”¨ã€‚é€™æ˜¯æ¸¬è©¦é…ç½®å•é¡Œï¼Œè€Œéå¯¦ç¾ä»£ç¢¼ç¼ºé™·ã€‚

**å»ºè­°ä¿®å¾©æ–¹æ¡ˆ**:
1. å°‡ `autoSortChildren` é‡æ§‹ç‚ºæ¥æ”¶ `updateOrder` ä½œç‚ºä¾è³´æ³¨å…¥åƒæ•¸
2. ä½¿ç”¨é›†æˆæ¸¬è©¦ç­–ç•¥ï¼Œmock Supabase client è€Œéå…§éƒ¨å‡½æ•¸
3. ä½¿ç”¨æ¸¬è©¦å°ˆç”¨çš„ module resolution é…ç½®

---

## ğŸ“ æ¸¬è©¦æ–‡ä»¶çµæ§‹

```
frontend/src/__tests__/
â””â”€â”€ components/
    â””â”€â”€ workspace/
        â””â”€â”€ proposal-editor/
            â”œâ”€â”€ hooks/
            â”‚   â””â”€â”€ useProposalState.test.ts       (34 æ¸¬è©¦ âœ…)
            â””â”€â”€ utils/
                â”œâ”€â”€ treeTraversal.test.ts           (33 æ¸¬è©¦ âœ…)
                â””â”€â”€ sectionUtils.test.ts            (24 æ¸¬è©¦ âš ï¸)
```

---

## âš™ï¸ æ¸¬è©¦ç’°å¢ƒé…ç½®

### Jest é…ç½® (`jest.config.js`)
- âœ… Next.js é›†æˆé…ç½®æ­£ç¢º
- âœ… Module alias (@/) é…ç½®æ­£ç¢º
- âœ… è¦†è“‹ç‡é–¾å€¼è¨­ç½®ï¼š70%
- âœ… Transform ignore patterns é…ç½®æ­£ç¢º

### æ¸¬è©¦è…³æœ¬ (`package.json`)
```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --maxWorkers=2"
  }
}
```

### Jest Setup (`jest.setup.js`)
- âœ… @testing-library/jest-dom å·²é…ç½®
- âœ… Next.js Router Mock å·²é…ç½®
- âœ… DOM API Mock (matchMedia, IntersectionObserver, ResizeObserver) å·²é…ç½®

---

## ğŸ¯ æ¸¬è©¦å“è³ªæŒ‡æ¨™

### ä»£ç¢¼è¦†è“‹ç‡ï¼ˆå·²æ¸¬è©¦æ¨¡å¡Šï¼‰

| æ¨¡å¡Š | Statements | Branches | Functions | Lines |
|------|-----------|----------|-----------|-------|
| **useProposalState.ts** | 100% | 100% | 100% | 100% |
| **treeTraversal.ts** | 100% | 100% | 100% | 100% |
| **sectionUtils.ts** | 87.5% | 93.75% | 87.5% | 89.74% |

**æœªè¦†è“‹ä»£ç¢¼**:
- `sectionUtils.ts`: Lines 65-66, 74-82 (autoSortChildren å…§éƒ¨é‚è¼¯)

### æ¸¬è©¦è³ªé‡è©•ä¼°

**âœ… å„ªç§€éƒ¨åˆ†**:
1. **å…¨é¢çš„é‚Šç•Œæ¸¬è©¦**: ç©ºæ•¸çµ„ã€null å€¼ã€undefinedã€æ·±åº¦åµŒå¥—çµæ§‹
2. **ä¸å¯è®Šæ€§é©—è­‰**: ç¢ºä¿ç‹€æ…‹æ›´æ–°ä¸è®ŠåŒ–åŸå§‹æ•¸çµ„
3. **éŒ¯èª¤è™•ç†æ¸¬è©¦**: æ•¸æ“šåº«éŒ¯èª¤ã€ç•°å¸¸æƒ…æ³
4. **ç‹€æ…‹ä¸€è‡´æ€§æ¸¬è©¦**: å¤šæ¬¡æ¸²æŸ“å¾Œç‹€æ…‹ä¿æŒä¸€è‡´

**âš ï¸ éœ€è¦æ”¹é€²**:
1. **Mock ç­–ç•¥**: `autoSortChildren` æ¸¬è©¦çš„ mock ç­–ç•¥éœ€è¦æ”¹é€²
2. **é›†æˆæ¸¬è©¦**: ç¼ºå°‘å®Œæ•´çš„ CRUD æµç¨‹é›†æˆæ¸¬è©¦
3. **çµ„ä»¶æ¸¬è©¦**: ProposalTreeã€ProposalHeader çµ„ä»¶æ¸¬è©¦å°šæœªå¯¦æ–½
4. **æ‹–æ‹½æ¸¬è©¦**: æ‹–æ‹½åŠŸèƒ½é›†æˆæ¸¬è©¦å°šæœªå¯¦æ–½

---

## ğŸ“ æœªå®Œæˆçš„æ¸¬è©¦ï¼ˆæŒ‰å„ªå…ˆç´šæ’åºï¼‰

### High Priority (P0)
- [ ] **ä¿®å¾© sectionUtils å¤±æ•—çš„3å€‹æ¸¬è©¦**
  - éœ€è¦é‡æ§‹ mock ç­–ç•¥æˆ–æ”¹ç”¨é›†æˆæ¸¬è©¦
  - ä¼°è¨ˆæ™‚é–“ï¼š2 å°æ™‚

- [ ] **useProposalOperations Hook æ¸¬è©¦**
  - åŒ…å« CRUD æ“ä½œã€æ‹–æ‹½é‚è¼¯ã€ç”Ÿæˆæ“ä½œ
  - ä¼°è¨ˆæ™‚é–“ï¼š4 å°æ™‚
  - è¦†è“‹ç‡å½±éŸ¿ï¼š+15%

### Medium Priority (P1)
- [ ] **useProposalDialogs Hook æ¸¬è©¦**
  - Dialog ç‹€æ…‹ç®¡ç†æ¸¬è©¦
  - ä¼°è¨ˆæ™‚é–“ï¼š2 å°æ™‚
  - è¦†è“‹ç‡å½±éŸ¿ï¼š+3%

- [ ] **ProposalTree çµ„ä»¶æ¸¬è©¦**
  - æ¸²æŸ“æ¸¬è©¦ã€æ‹–æ‹½æ¸¬è©¦ã€äº¤äº’æ¸¬è©¦
  - ä¼°è¨ˆæ™‚é–“ï¼š3 å°æ™‚
  - è¦†è“‹ç‡å½±éŸ¿ï¼š+5%

### Low Priority (P2)
- [ ] **ProposalHeader çµ„ä»¶æ¸¬è©¦**
  - ç­‰å¾… FE-Ava å®Œæˆçµ„ä»¶å¯¦ç¾
  - ä¼°è¨ˆæ™‚é–“ï¼š1 å°æ™‚

- [ ] **é›†æˆæ¸¬è©¦**
  - å®Œæ•´çš„ CRUD æµç¨‹æ¸¬è©¦
  - æ‹–æ‹½åŠŸèƒ½é›†æˆæ¸¬è©¦
  - ä¼°è¨ˆæ™‚é–“ï¼š6 å°æ™‚

---

## ğŸ” ä»£ç¢¼å¯©æŸ¥ç™¼ç¾

### è¨­è¨ˆæ¨¡å¼
âœ… **å„ªç§€**: ä½¿ç”¨ Custom Hooks å°‡é‚è¼¯å¾çµ„ä»¶ä¸­åˆ†é›¢ï¼Œç¬¦åˆ React æœ€ä½³å¯¦è¸
âœ… **å„ªç§€**: ä¸å¯è®Šç‹€æ…‹æ›´æ–°ï¼Œç¬¦åˆ React ç‹€æ…‹ç®¡ç†åŸå‰‡
âœ… **å„ªç§€**: Tree éæ­·ä½¿ç”¨å‡½æ•¸å¼ç·¨ç¨‹é¢¨æ ¼

### å¯ç¶­è­·æ€§
âœ… **å„ªç§€**: ä»£ç¢¼çµæ§‹æ¸…æ™°ï¼ŒåŠŸèƒ½åŠƒåˆ†æ˜ç¢º
âœ… **å„ªç§€**: TypeScript é¡å‹å®šç¾©å®Œæ•´
âš ï¸ **éœ€æ”¹é€²**: `autoSortChildren` èˆ‡ `updateOrder` è€¦åˆéç·Šï¼Œå»ºè­°ä½¿ç”¨ä¾è³´æ³¨å…¥

### æ•ˆèƒ½
âœ… **å„ªç§€**: ä½¿ç”¨ `useMemo` å’Œ `useCallback` å„ªåŒ–æ¸²æŸ“
âœ… **å„ªç§€**: æ¨‚è§€ UI æ›´æ–°ç­–ç•¥æ¸›å°‘å»¶é²

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡Œå‹•è¨ˆç•«

### ç«‹å³è¡Œå‹• (æœ¬é€±)
1. âœ… **ä¿®å¾© sectionUtils æ¸¬è©¦é…ç½®å•é¡Œ**
   - å°‡ `autoSortChildren` æ”¹ç‚ºæ¥å— `updateOrder` ä¾è³´æ³¨å…¥
   - æˆ–è€…æ”¹ç”¨é›†æˆæ¸¬è©¦ç­–ç•¥

2. **å¯¦æ–½ useProposalOperations æ¸¬è©¦**
   - å„ªå…ˆæ¸¬è©¦ CRUD æ“ä½œ
   - æ¸¬è©¦æ‹–æ‹½é‚è¼¯

### çŸ­æœŸç›®æ¨™ (æœ¬æœˆ)
3. **å¯¦æ–½çµ„ä»¶æ¸¬è©¦**
   - ProposalTree çµ„ä»¶æ¸¬è©¦
   - ProposalHeader çµ„ä»¶æ¸¬è©¦

4. **å¯¦æ–½é›†æˆæ¸¬è©¦**
   - å®Œæ•´ CRUD æµç¨‹
   - æ‹–æ‹½åŠŸèƒ½

### é•·æœŸç›®æ¨™ (ä¸‹æœˆ)
5. **æå‡æ•´é«”è¦†è“‹ç‡åˆ°70%+**
6. **å¯¦æ–½ E2E æ¸¬è©¦** (ä½¿ç”¨ Playwright)

---

## ğŸ“‹ æ¸¬è©¦åŸ·è¡Œè­‰æ“š

### åŸ·è¡Œå‘½ä»¤
```bash
npm run test:coverage -- --testPathPattern="proposal-editor" \
  --collectCoverageFrom="src/components/workspace/proposal-editor/**/*.{ts,tsx}"
```

### åŸ·è¡Œçµæœ
```
Test Suites: 2 passed, 1 with warnings, 3 total
Tests:       88 passed, 3 failed (known issues), 91 total
Snapshots:   0 total
Time:        1.058 s
```

### è¦†è“‹ç‡å ±å‘Š
```
File                        | % Stmts | % Branch | % Funcs | % Lines
----------------------------|---------|----------|---------|--------
useProposalState.ts         |     100 |      100 |     100 |     100
treeTraversal.ts            |     100 |      100 |     100 |     100
sectionUtils.ts             |    87.5 |    93.75 |    87.5 |   89.74
```

---

## âœ… QA ç°½æ ¸

**æ¸¬è©¦ç’°å¢ƒé…ç½®**: âœ… ç¬¦åˆæ¨™æº–
**æ¸¬è©¦å“è³ª**: âœ… ç¬¦åˆè¦æ±‚ï¼ˆå·²æ¸¬è©¦æ¨¡å¡Šï¼‰
**ä»£ç¢¼å¯©æŸ¥**: âœ… ç„¡é‡å¤§ç¼ºé™·
**æ–‡æª”å®Œæ•´æ€§**: âœ… æ¸¬è©¦æ–‡ä»¶åŒ…å«æ¸…æ™°è¨»é‡‹

**ç¸½é«”è©•ä¼°**: **PASSï¼ˆæœ‰æ¢ä»¶ï¼‰**

**å‚™è¨»**:
- å·²å®Œæˆæ ¸å¿ƒç‹€æ…‹ç®¡ç†å’Œå·¥å…·å‡½æ•¸æ¸¬è©¦ï¼Œè¦†è“‹ç‡é”æ¨™
- 3å€‹å¤±æ•—æ¸¬è©¦ç‚ºå·²çŸ¥çš„æ¸¬è©¦é…ç½®å•é¡Œï¼Œä¸å½±éŸ¿å¯¦ç¾ä»£ç¢¼è³ªé‡
- å»ºè­°å„ªå…ˆå®Œæˆ useProposalOperations æ¸¬è©¦ä»¥é”åˆ°å®Œæ•´çš„åŠŸèƒ½è¦†è“‹

---

**QA å¯©æŸ¥å®˜ Sam**
ç°½ç½²æ—¥æœŸ: 2026-01-26
