# OnlyOffice AI 功能測試指南

## 📋 測試總覽

本指南將帶你完成 OnlyOffice AI 功能的完整測試流程。

---

## 🧪 階段 1：後端 API 測試（已完成 ✅）

### 自動化測試

已運行自動化測試腳本，結果如下：

```
✅ 測試 1: CORS 配置正常
✅ 測試 2: 認證保護正常（未登入用戶被拒絕）
✅ 測試 3: 環境變數配置檢查
```

### 手動測試（可選）

如果你想再次測試，執行：

```bash
cd frontend
node test-ai-proxy.js
```

---

## 🌐 階段 2：前端編輯器測試

### 步驟 1：啟動開發伺服器

```bash
cd frontend
npm run dev
```

確認伺服器運行在 `http://localhost:3000`

### 步驟 2：登入系統

1. 打開瀏覽器訪問 `http://localhost:3000`
2. 使用你的帳號登入
3. 確認已成功登入（右上角應該顯示用戶信息）

### 步驟 3：打開模板編輯器

1. 前往「模板管理」頁面
2. 選擇任意一個現有模板
3. 點擊「編輯」按鈕
4. 等待 OnlyOffice 編輯器加載完成

---

## 🔌 階段 3：安裝 AI 插件

### 步驟 1：打開插件管理器

在 OnlyOffice 編輯器中：

1. 查看頂部工具欄
2. 找到「插件」圖標（🧩 拼圖形狀）
3. 點擊打開插件管理器

> **如果找不到插件圖標**：
> - 確認 `customization.plugins: true` 已設置（已完成）
> - 嘗試刷新頁面
> - 檢查 OnlyOffice 版本是否 ≥ 9.0.4

### 步驟 2：安裝 AI 插件

在插件管理器中：

1. 找到以下任一插件：
   - 「AI Helper」
   - 「ChatGPT」
   - 「AI Assistant」

2. 點擊插件卡片

3. 點擊「Install」（安裝）按鈕

4. 等待安裝完成（通常需要 5-10 秒）

5. 安裝成功後，工具欄右側會出現 AI 插件圖標（通常是 🤖 或 ✨）

---

## ⚙️ 階段 4：配置自定義 AI 提供商

### 步驟 1：打開 AI 插件設置

1. 點擊工具欄的 AI 插件圖標
2. AI 面板會在右側展開
3. 找到「Settings」（設置）或齒輪圖標 ⚙️
4. 點擊進入設置頁面

### 步驟 2：添加自定義提供商

在設置頁面中：

1. 找到「Add Custom Provider」或「自定義提供商」選項
2. 點擊「Add」或「新增」

3. 填寫以下配置：

   | 欄位 | 值 | 說明 |
   |------|-----|------|
   | **Provider Name** | `Azure OpenAI (本地代理)` | 任意名稱 |
   | **API URL** | `http://localhost:3000/api/ai-proxy/azure-openai` | 代理 API 端點 |
   | **API Key** | `proxy-managed` | 任意值（實際由後端管理） |
   | **Model** | `gpt-4` | 或留空 |

4. 點擊「Save」或「保存」

### 步驟 3：選擇提供商

1. 回到 AI 插件主面板
2. 在提供商下拉選單中選擇「Azure OpenAI (本地代理)」
3. 確認已選中（通常會有勾選標記）

---

## 🧪 階段 5：功能測試

### 測試 1：文本生成

1. 在文檔中輸入：
   ```
   請撰寫一段關於人工智能在現代社會中應用的介紹，約 100 字。
   ```

2. 選中這段文字（用滑鼠拖曳選取）

3. 點擊 AI 插件圖標

4. 在 AI 面板中，選擇以下任一功能：
   - 「Generate」（生成）
   - 「Complete」（補全）
   - 或類似選項

5. **預期結果**：
   - AI 會生成一段關於 AI 應用的文字
   - 生成的文字會自動插入到文檔中
   - 過程大約需要 3-5 秒

6. **如果成功**：✅ 文本生成功能正常

7. **如果失敗**：
   - 檢查瀏覽器控制台（F12）是否有錯誤
   - 檢查網路請求（Network 標籤）
   - 查看下方的故障排除章節

### 測試 2：文本改寫

1. 在文檔中輸入一段文字：
   ```
   我們公司正在進行數位轉型，這個過程需要很多資源和時間。
   ```

2. 選中這段文字

3. 點擊 AI 插件圖標

4. 選擇「Rewrite」（改寫）或「Improve」（改善）

5. **預期結果**：
   - AI 會提供改寫後的版本
   - 文字更加專業和流暢

6. **如果成功**：✅ 文本改寫功能正常

### 測試 3：內容總結

1. 在文檔中輸入或貼上一段較長的文字（200 字以上）

2. 選中整段文字

3. 點擊 AI 插件圖標

4. 選擇「Summarize」（總結）

5. **預期結果**：
   - AI 會生成簡短的摘要
   - 摘要涵蓋主要要點

6. **如果成功**：✅ 內容總結功能正常

### 測試 4：翻譯功能（如果插件支持）

1. 在文檔中輸入中文文字：
   ```
   人工智能正在改變我們的生活方式。
   ```

2. 選中文字

3. 點擊 AI 插件

4. 選擇「Translate」或「翻譯」

5. 選擇目標語言（例如：英文）

6. **預期結果**：
   - AI 生成英文翻譯
   - 翻譯準確且自然

7. **如果成功**：✅ 翻譯功能正常

---

## 🔍 階段 6：驗證安全性

### 測試 1：檢查 API 密鑰未暴露

1. 打開瀏覽器開發者工具（F12）

2. 切換到「Network」（網路）標籤

3. 使用 AI 功能（執行任意測試）

4. 在 Network 標籤中，找到對 `/api/ai-proxy/azure-openai` 的請求

5. 點擊該請求，查看「Headers」（標頭）

6. **檢查**：
   - ❌ `Authorization` header 中**不應該包含** Azure API 密鑰
   - ✅ 應該只看到 cookie（Supabase session）
   - ✅ 不應該看到 `ba6946b167174ece95e7419976aa6a33`

7. **如果密鑰未暴露**：✅ 安全性正常

### 測試 2：驗證速率限制

1. 連續快速點擊 AI 生成功能（超過 20 次）

2. **預期結果**：
   - 前 20 次請求正常
   - 第 21 次開始返回錯誤：「Too many requests. Please try again later.」
   - 回應狀態碼：429

3. 等待 1 分鐘後，再次測試

4. **預期結果**：速率限制重置，可以再次使用

5. **如果限制生效**：✅ 速率限制正常

### 測試 3：未登入用戶測試

1. 登出系統（或使用無痕模式）

2. 嘗試訪問 `/api/ai-proxy/azure-openai`

3. **預期結果**：返回 401 Unauthorized

4. **如果被拒絕**：✅ 認證保護正常

---

## 📊 階段 7：檢查日誌

### 前端日誌

打開瀏覽器控制台（F12），查看：

```
[AI Proxy] Request from user: xxx-xxx-xxx Messages: 1
[AI Proxy] Azure OpenAI response received
```

### 後端日誌

查看終端（運行 `npm run dev` 的窗口），應該看到：

```
[AI Proxy] Request from user: <user-id> Messages: 1
[AI Proxy] Azure OpenAI response received
```

---

## 🐛 故障排除

### 問題 1：插件圖標未出現

**症狀**：工具欄中沒有插件圖標（🧩）

**可能原因**：
- `plugins: true` 未設置
- OnlyOffice 版本過舊
- 瀏覽器快取問題

**解決方案**：
1. 確認 `OnlyOfficeEditorWithUpload.tsx` 中 `customization.plugins: true` 已設置（已完成）
2. 清除瀏覽器快取並刷新
3. 嘗試使用無痕模式
4. 檢查 OnlyOffice 版本：
   ```bash
   # 在終端執行
   curl http://5.78.118.41:8080/web-apps/apps/api/documents/api.js | grep -i version
   ```

### 問題 2：AI 插件安裝失敗

**症狀**：點擊「Install」後沒有反應或出現錯誤

**可能原因**：
- OnlyOffice Plugin Marketplace 連線問題
- 網路防火牆限制

**解決方案**：
1. 檢查網路連線
2. 嘗試重新載入編輯器
3. 查看瀏覽器控制台錯誤訊息

### 問題 3：AI 請求返回 401

**症狀**：使用 AI 功能時返回「Unauthorized」

**可能原因**：
- 用戶未登入
- Supabase session 過期

**解決方案**：
1. 確認已登入系統
2. 重新登入
3. 檢查瀏覽器 Cookies 是否被禁用

### 問題 4：AI 請求返回 500

**症狀**：AI 功能返回「Internal Server Error」

**可能原因**：
- Azure OpenAI 配置錯誤
- API 密鑰無效
- 環境變數未正確載入

**解決方案**：
1. 檢查 `.env.local` 中的配置：
   ```bash
   cat frontend/.env.local | grep AZURE_OPENAI
   ```

2. 確認輸出包含：
   ```
   AZURE_OPENAI_ENDPOINT=https://ocrgpt4.openai.azure.com
   AZURE_OPENAI_KEY=ba6946b167174ece95e7419976aa6a33
   AZURE_OPENAI_DEPLOYMENT=gpt-4.1
   AZURE_OPENAI_API_VERSION=2025-01-01-preview
   ```

3. 重啟開發伺服器：
   ```bash
   # 停止伺服器（Ctrl+C）
   # 重新啟動
   npm run dev
   ```

4. 查看後端日誌錯誤訊息

### 問題 5：AI 回應很慢或超時

**症狀**：等待超過 30 秒沒有回應

**可能原因**：
- Azure OpenAI API 延遲
- 網路問題
- 請求內容過長

**解決方案**：
1. 縮短輸入文字長度
2. 檢查網路連線
3. 查看 Azure OpenAI 服務狀態
4. 增加超時時間（需修改代碼）

### 問題 6：自定義提供商無法保存

**症狀**：配置後重新打開設置，配置消失

**可能原因**：
- OnlyOffice 插件版本問題
- 瀏覽器 localStorage 被禁用

**解決方案**：
1. 確認瀏覽器允許 localStorage
2. 更新 AI 插件到最新版本
3. 嘗試使用其他瀏覽器

---

## 📋 測試檢查清單

完成以下檢查清單，確保所有功能正常：

### 後端測試
- [ ] ✅ CORS 配置正常
- [ ] ✅ 認證保護正常
- [ ] ✅ 環境變數配置正確

### 前端測試
- [ ] 開發伺服器成功啟動
- [ ] 成功登入系統
- [ ] OnlyOffice 編輯器正常載入

### 插件測試
- [ ] 插件圖標出現在工具欄
- [ ] 成功打開插件管理器
- [ ] 成功安裝 AI 插件
- [ ] AI 插件圖標出現在工具欄

### 配置測試
- [ ] 成功打開 AI 插件設置
- [ ] 成功添加自定義提供商
- [ ] 配置保存成功
- [ ] 成功選擇自定義提供商

### 功能測試
- [ ] ✅ 文本生成功能正常
- [ ] ✅ 文本改寫功能正常
- [ ] ✅ 內容總結功能正常
- [ ] ✅ 翻譯功能正常（如果支持）

### 安全性測試
- [ ] ✅ API 密鑰未暴露到前端
- [ ] ✅ 速率限制正常運作
- [ ] ✅ 未登入用戶被拒絕

### 日誌測試
- [ ] 前端控制台顯示正確日誌
- [ ] 後端終端顯示正確日誌

---

## 🎯 下一步

### 如果所有測試通過

恭喜！🎉 OnlyOffice AI 功能已完全整合並正常運作。

**建議下一步**：
1. 向團隊展示 AI 功能
2. 收集用戶反饋
3. 監控 API 使用情況
4. 考慮增加更多 AI 功能（如：OCR、圖片生成等）

### 如果有測試失敗

1. 參考「故障排除」章節
2. 檢查瀏覽器控制台和伺服器日誌
3. 確認所有配置正確
4. 必要時聯繫技術支援

---

## 📞 技術支援

如遇問題，請提供以下信息：

1. **瀏覽器控制台截圖**（F12 → Console）
2. **網路請求詳情**（F12 → Network → 點擊失敗的請求）
3. **伺服器日誌**（終端輸出）
4. **具體操作步驟**（如何重現問題）

---

**最後更新**：2026-01-28
