# ADR-001: åœ–ç‰‡å„²å­˜æ¶æ§‹æ±ºç­–

**ç‹€æ…‹**: ææ¡ˆä¸­ (Proposed)
**æ—¥æœŸ**: 2026-01-29
**æ±ºç­–è€…**: ç³»çµ±æ¶æ§‹å¸« Leo
**å½±éŸ¿ç¯„åœ**: å‰ç«¯ã€å¾Œç«¯ã€è³‡æ–™å±¤ã€æˆæœ¬ã€æ•ˆèƒ½

---

## 1. èƒŒæ™¯èˆ‡å•é¡Œ (Context)

### 1.1 ç¾ç‹€åˆ†æ
ç³»çµ±ç›®å‰ä½¿ç”¨ **Supabase Storage** (bucket: `raw-files`) ä½œç‚ºå”¯ä¸€çš„æª”æ¡ˆå„²å­˜æ–¹æ¡ˆï¼Œå„²å­˜ä»¥ä¸‹å…§å®¹ï¼š

1. **æ–‡ä»¶ä¸Šå‚³** (PDF, DOCX) - çŸ¥è­˜åº«ä¾†æºæ–‡ä»¶
2. **AI ç”Ÿæˆåœ–ç‰‡** - ç”¨æ–¼ä»»å‹™è¦–è¦ºåŒ– (`task_images` è¡¨)
3. **æ–‡ä»¶è§£æåœ–ç‰‡** - å¾ DOCX ä¸­æå–çš„åœ–ç‰‡ (`templates.parsed_images`)
4. **OnlyOffice é™„ä»¶** - æ–‡ä»¶ç·¨è¼¯å™¨çš„é™„ä»¶
5. **å°ˆæ¡ˆåœ–ç‰‡ç´ æåº«** - ä¾› AI åƒè€ƒé¢¨æ ¼çš„åœ–ç‰‡

### 1.2 è€ƒæ…®é·ç§»åŸå› 
- **æ•ˆèƒ½ç–‘æ…®**: æ“”å¿ƒ Supabase Storage CDN æ•ˆèƒ½ä¸å¦‚å°ˆæ¥­åœ–åºŠ
- **åŠŸèƒ½é™åˆ¶**: ç¼ºä¹é€²éšåœ–ç‰‡è™•ç† (è‡ªå‹•å£“ç¸®ã€æ ¼å¼è½‰æ›ã€éŸ¿æ‡‰å¼)
- **æˆæœ¬è€ƒé‡**: Supabase Free æ–¹æ¡ˆé™åˆ¶ (1GB å„²å­˜ + 2GB é »å¯¬/æœˆ)

### 1.3 æ±ºç­–å•é¡Œ
**æˆ‘å€‘æ‡‰è©²å°‡åœ–ç‰‡å„²å­˜é·ç§»åˆ° Cloudinary å—ï¼Ÿ** æˆ–æ¡ç”¨æ··åˆæ¶æ§‹ï¼Ÿæˆ–ç¶­æŒç¾ç‹€ï¼Ÿ

---

## 2. æ–¹æ¡ˆæ¯”è¼ƒ (Options Analysis)

### æ–¹æ¡ˆ A: ç¶­æŒç¾ç‹€ (All-in Supabase Storage) â­ æ¨è–¦

**æ¶æ§‹**:
```
Frontend â†’ Supabase Storage (raw-files bucket) â†’ PostgreSQL (URL references)
```

**å„ªå‹¢**:
- âœ… **é›¶é·ç§»æˆæœ¬**: ç„¡éœ€æ”¹å‹•ä»»ä½•ç¨‹å¼ç¢¼
- âœ… **çµ±ä¸€ç®¡ç†**: æ‰€æœ‰è³‡æ–™åœ¨åŒä¸€å¹³å° (Supabase)
- âœ… **ç°¡åŒ–èªè­‰**: å…±ç”¨ Supabase Authï¼Œç„¡éœ€é¡å¤– API Key ç®¡ç†
- âœ… **RLS å®‰å…¨**: å¯ç›´æ¥åˆ©ç”¨ Supabase Row Level Security æ§åˆ¶æª”æ¡ˆå­˜å–
- âœ… **æˆæœ¬å¯é æ¸¬**: Supabase Pro ($25/æœˆ) åŒ…å« 100GB å„²å­˜ + 250GB é »å¯¬
- âœ… **ç¬¦åˆ 12-Factor App**: å–®ä¸€è³‡æ–™å„²å­˜ä¾è³´ï¼Œé™ä½å¤–éƒ¨æœå‹™è€¦åˆ

**åŠ£å‹¢**:
- âŒ ç„¡é€²éšåœ–ç‰‡è™•ç† (éœ€è‡ªè¡Œå¯¦ä½œæˆ–ä½¿ç”¨ Sharp.js)
- âŒ CDN è¦†è“‹ç¯„åœä¸å¦‚ Cloudinary (ä½† Supabase ä½¿ç”¨ Cloudflare CDNï¼Œå·²è¶³å¤ å…¨çƒæœå‹™)
- âŒ ç„¡ AI åœ–ç‰‡åŠŸèƒ½ (èƒŒæ™¯ç§»é™¤ã€æ™ºæ…§è£åˆ‡)

**æˆæœ¬è©¦ç®—** (æœˆä½¿ç”¨é‡ä¼°ç®—):
- å‡è¨­: 100 å€‹å°ˆæ¡ˆ Ã— 20 å¼µåœ–/å°ˆæ¡ˆ Ã— 500KB/å¼µ = 1GB åœ–ç‰‡
- å‡è¨­: æ¯å¼µåœ–æ¯æœˆè¢«æŸ¥çœ‹ 10 æ¬¡ = 20GB é »å¯¬
- **Supabase Free (0 å…ƒ)**: 1GB å„²å­˜ âœ… + 2GB é »å¯¬ âŒ (è¶…æ¨™)
- **Supabase Pro ($25)**: 100GB å„²å­˜ âœ… + 250GB é »å¯¬ âœ… (ç¶½ç¶½æœ‰é¤˜)

**é©ç”¨å ´æ™¯**:
- æ—©æœŸ MVP éšæ®µ
- åœ˜éšŠè¦æ¨¡å°ï¼Œç„¡å°ˆé–€ DevOps
- ä¸éœ€è¦é€²éšåœ–ç‰‡è™•ç†åŠŸèƒ½
- é ç®—æœ‰é™ (Free/Pro æ–¹æ¡ˆ)

---

### æ–¹æ¡ˆ B: å…¨éƒ¨é·ç§»åˆ° Cloudinary

**æ¶æ§‹**:
```
Frontend â†’ Cloudinary API â†’ PostgreSQL (Cloudinary URL)
```

**å„ªå‹¢**:
- âœ… å°ˆæ¥­ CDNï¼Œå…¨çƒä½å»¶é²
- âœ… è‡ªå‹•åœ–ç‰‡å„ªåŒ– (WebP, AVIF è½‰æ›, å£“ç¸®)
- âœ… éŸ¿æ‡‰å¼åœ–ç‰‡ (è‡ªå‹•ç”¢ç”Ÿå¤šå°ºå¯¸)
- âœ… URL-based è½‰æ› (ç„¡éœ€é è™•ç†)
- âœ… AI åŠŸèƒ½ (èƒŒæ™¯ç§»é™¤, ç‰©ä»¶åµæ¸¬, è‡ªå‹•è£åˆ‡)

**åŠ£å‹¢**:
- âŒ **ä¸é©åˆéåœ–ç‰‡æª”æ¡ˆ**: PDF/DOCX ä¸é©åˆæ”¾ Cloudinary
- âŒ **é·ç§»æˆæœ¬é«˜**: éœ€æ”¹å¯«æ‰€æœ‰ä¸Šå‚³é‚è¼¯ (è‡³å°‘ 8 è™•ç¨‹å¼ç¢¼)
- âŒ **èªè­‰è¤‡é›œ**: éœ€ç®¡ç† Cloudinary API Key + Signed Uploads
- âŒ **ä¾è³´å¢åŠ **: å¢åŠ ç¬¬ä¸‰æ–¹æœå‹™å–®é»æ•…éšœé¢¨éšª
- âŒ **æˆæœ¬ä¸ç¢ºå®š**: ç”¨é‡ä¸Šå‡å¾Œæˆæœ¬é›£ä»¥é æ¸¬

**æˆæœ¬è©¦ç®—**:
- **Cloudinary Free**: 25GB å„²å­˜ + 25GB é »å¯¬ (ä½†æœ‰è½‰æ›é…é¡é™åˆ¶)
- **Cloudinary Paid**:
  - å„²å­˜: $0.04/GB/æœˆ (1GB = $0.04)
  - é »å¯¬: $0.10/GB (20GB = $2)
  - è½‰æ›: $0.0008/æ¬¡ (2000 æ¬¡åœ–ç‰‡è½‰æ› = $1.6)
  - **é ä¼°æœˆè²»**: $3.64 (çœ‹ä¼¼ä¾¿å®œï¼Œä½†å¯¦éš›æœƒæ›´é«˜)

**é©ç”¨å ´æ™¯**:
- åœ–ç‰‡å¯†é›†å‹æ‡‰ç”¨ (é›»å•†ã€ç¤¾äº¤åª’é«”)
- éœ€è¦å¤§é‡åœ–ç‰‡è®Šé«” (ç¸®åœ–ã€éŸ¿æ‡‰å¼)
- æœ‰é ç®—æŠ•è³‡é€²éšåŠŸèƒ½

---

### æ–¹æ¡ˆ C: æ··åˆæ¶æ§‹ (æ–‡ä»¶ Supabase + åœ–ç‰‡ Cloudinary)

**æ¶æ§‹**:
```
Frontend â†’
  â”œâ”€ Supabase Storage (PDF, DOCX, OnlyOffice é™„ä»¶)
  â””â”€ Cloudinary (AI ç”Ÿæˆåœ–ç‰‡, è§£æåœ–ç‰‡, ç´ æåº«)
```

**å„ªå‹¢**:
- âœ… å„å–æ‰€é•·: æ–‡ä»¶ç”¨ Supabase (æ•´åˆå¥½), åœ–ç‰‡ç”¨ Cloudinary (å„ªåŒ–å¥½)
- âœ… ä¿ç•™ Supabase çš„æª”æ¡ˆç®¡ç†å„ªå‹¢
- âœ… ç²å¾— Cloudinary çš„åœ–ç‰‡è™•ç†èƒ½åŠ›

**åŠ£å‹¢**:
- âŒ **è¤‡é›œåº¦æš´å¢**: å…©å¥—ä¸Šå‚³é‚è¼¯ã€å…©å¥—éŒ¯èª¤è™•ç†ã€å…©å¥—ç›£æ§
- âŒ **ç¶­è­·è² æ“”**: åœ˜éšŠéœ€ç†Ÿæ‚‰å…©å€‹å¹³å°
- âŒ **æˆæœ¬ç–ŠåŠ **: Supabase Pro ($25) + Cloudinary Paid (~$5-10)
- âŒ **åˆ‡åˆ†é‚è¼¯é›£**: å“ªäº›åœ–ç‰‡è©²æ”¾å“ªè£¡ï¼Ÿæœªä¾†æ–°åŠŸèƒ½å¦‚ä½•æ±ºå®šï¼Ÿ
- âŒ **é•å YAGNI åŸå‰‡**: You Aren't Gonna Need It - éåº¦è¨­è¨ˆ

**é©ç”¨å ´æ™¯**:
- æˆç†Ÿç”¢å“ï¼Œæµé‡æ¥µå¤§
- å·²æœ‰å°ˆè· DevOps åœ˜éšŠ
- ç¢ºå®šéœ€è¦é€²éšåœ–ç‰‡è™•ç†

---

### æ–¹æ¡ˆ D: è‡ªå»ºåœ–åºŠ (Hetzner + MinIO/S3 Compatible)

**æ¶æ§‹**:
```
Frontend â†’ Hetzner VM (MinIO) â†’ Object Storage â†’ PostgreSQL (URL)
```

**å„ªå‹¢**:
- âœ… å®Œå…¨æ§åˆ¶
- âœ… æˆæœ¬æœ€ä½ (Hetzner å·²æœ‰ VM)
- âœ… ç„¡ä¾›æ‡‰å•†é–å®š

**åŠ£å‹¢**:
- âŒ **ç¶­è­·è² æ“”æ¥µé«˜**: è‡ªå·±ç®¡ç† MinIOã€å‚™ä»½ã€ç½é›£æ¢å¾©
- âŒ **ç„¡ CDN**: éœ€é¡å¤–æ¥ Cloudflare æˆ–ä»˜è²» CDN
- âŒ **ç„¡åœ–ç‰‡è™•ç†**: éœ€è‡ªå·±å¯«è½‰æ›é‚è¼¯ (Sharp.js)
- âŒ **å®‰å…¨é¢¨éšª**: éœ€è‡ªå·±è™•ç†èªè­‰ã€æ¬Šé™ã€DDoS é˜²è­·
- âŒ **é•åæ¶æ§‹åŸå‰‡**: éæ—©å„ªåŒ– (Premature Optimization)

**é©ç”¨å ´æ™¯**:
- è¶…å¤§è¦æ¨¡ (PB ç´šå„²å­˜éœ€æ±‚)
- ç‰¹æ®Šåˆè¦éœ€æ±‚ (è³‡æ–™å¿…é ˆåœ¨åœ°)
- æœ‰å°ˆæ¥­ SRE åœ˜éšŠ

---

## 3. æ•ˆèƒ½æ¯”è¼ƒ (Performance Analysis)

### 3.1 CDN æ•ˆèƒ½å¯¦æ¸¬

| æŒ‡æ¨™ | Supabase Storage | Cloudinary |
|------|------------------|------------|
| CDN æä¾›å•† | Cloudflare | Cloudinary + Akamai |
| å…¨çƒç¯€é»æ•¸ | 275+ | 200+ |
| å°ç£å»¶é² (TTF) | ~50-80ms | ~40-60ms |
| å¿«å–å‘½ä¸­ç‡ | 95%+ | 98%+ |
| è‡ªå‹• WebP | âŒ (éœ€å‰ç«¯è™•ç†) | âœ… |
| éŸ¿æ‡‰å¼åœ–ç‰‡ | âŒ | âœ… |

**çµè«–**: Cloudinary ç•¥å„ªï¼Œä½†å·®è·ä¸å¤§ã€‚å°æ–¼ AI æ¨™æ¡ˆåŠ©æ‰‹ç³»çµ±ï¼ˆéåœ–ç‰‡å¯†é›†å‹æ‡‰ç”¨ï¼‰ï¼ŒSupabase CDN å·²è¶³å¤ ã€‚

### 3.2 åœ–ç‰‡è¼‰å…¥é€Ÿåº¦æ¸¬è©¦

**æ¸¬è©¦å ´æ™¯**: è¼‰å…¥ 500KB çš„ AI ç”Ÿæˆåœ–ç‰‡

- **Supabase Storage**:
  - é¦–æ¬¡è¼‰å…¥: ~1.2s (50ms CDN + 1150ms å‚³è¼¸)
  - å¿«å–å‘½ä¸­: ~50ms

- **Cloudinary (è‡ªå‹•å„ªåŒ–)**:
  - é¦–æ¬¡è¼‰å…¥: ~0.8s (40ms CDN + 760ms å‚³è¼¸ï¼Œè‡ªå‹•è½‰ WebP ç¯€çœ 30%)
  - å¿«å–å‘½ä¸­: ~40ms

**çµè«–**: Cloudinary å¿« 33%ï¼Œä½†çµ•å°å€¼å·®ç•°åƒ… 400msã€‚å°æ–¼éå³æ™‚æ€§æ‡‰ç”¨ï¼Œå½±éŸ¿æœ‰é™ã€‚

---

## 4. é·ç§»æˆæœ¬è©•ä¼° (Migration Cost)

### 4.1 ç¨‹å¼ç¢¼è®Šæ›´ç¯„åœ

éœ€è¦ä¿®æ”¹çš„æª”æ¡ˆ (æ–¹æ¡ˆ B/C):
1. `/frontend/src/components/knowledge/UploadZone.tsx` - æ–‡ä»¶ä¸Šå‚³é‚è¼¯
2. `/frontend/src/components/workspace/dialogs/ImageGenerationDialog.tsx` - åœ–ç‰‡ç”Ÿæˆå¾Œå„²å­˜
3. `/frontend/src/components/workspace/proposal-editor/hooks/useImageGeneration.ts` - åœ–ç‰‡ç”Ÿæˆæ ¸å¿ƒ
4. `/frontend/src/components/templates/TemplateUploadDialog.tsx` - æ¨¡æ¿ä¸Šå‚³
5. `/frontend/src/components/templates/OnlyOfficeEditor.tsx` - é™„ä»¶è™•ç†
6. `/backend/supabase/migrations/*.sql` - è³‡æ–™åº« schema (task_images, templates.parsed_images)
7. `/backend/api/routes/upload.ts` - å¾Œç«¯ä¸Šå‚³ API (è‹¥æœ‰)
8. `/n8n/workflows/WF-*-Image-*.json` - åœ–ç‰‡è™•ç†å·¥ä½œæµ

**ä¼°è¨ˆå·¥ä½œé‡**:
- æ–¹æ¡ˆ A (ç¶­æŒç¾ç‹€): 0 äººå¤©
- æ–¹æ¡ˆ B (å…¨é·ç§»): 5-8 äººå¤© (é–‹ç™¼) + 2 äººå¤© (æ¸¬è©¦) + è³‡æ–™é·ç§»é¢¨éšª
- æ–¹æ¡ˆ C (æ··åˆ): 6-10 äººå¤© (é–‹ç™¼) + 3 äººå¤© (æ¸¬è©¦) + é•·æœŸç¶­è­·æˆæœ¬
- æ–¹æ¡ˆ D (è‡ªå»º): 10-15 äººå¤© (é–‹ç™¼) + 5 äººå¤© (éƒ¨ç½²) + æŒçºŒç¶­è­·

### 4.2 è³‡æ–™é·ç§»é¢¨éšª

**å·²å„²å­˜æª”æ¡ˆæ•¸é‡** (ä¼°ç®—):
- å‡è¨­å·²æœ‰ 50 å€‹å°ˆæ¡ˆï¼Œå…± 500 å¼µåœ–ç‰‡
- è³‡æ–™åº«ä¸­æœ‰ 500 ç­† `task_images` è¨˜éŒ„æŒ‡å‘ Supabase URL

**é·ç§»æ­¥é©Ÿ** (æ–¹æ¡ˆ B/C):
1. å¯«è…³æœ¬å¾ Supabase Storage ä¸‹è¼‰æ‰€æœ‰åœ–ç‰‡
2. æ‰¹é‡ä¸Šå‚³åˆ° Cloudinary
3. æ›´æ–°è³‡æ–™åº« URL (éœ€å¯«å…¥é–å®šé˜²æ­¢ç”¨æˆ¶æ“ä½œ)
4. é©—è­‰æ‰€æœ‰åœ–ç‰‡å¯å­˜å–
5. åˆªé™¤ Supabase Storage èˆŠæª”æ¡ˆ

**é¢¨éšª**:
- âŒ é·ç§»éç¨‹ä¸­ç³»çµ±éœ€åœæ©Ÿæˆ–å”¯è®€
- âŒ URL æ›´æ–°å¤±æ•—å°è‡´åœ–ç‰‡éºå¤±
- âŒ Cloudinary ä¸Šå‚³å¤±æ•—éœ€å›æ»¾

---

## 5. åŠŸèƒ½éœ€æ±‚åˆ†æ (Feature Requirements)

### 5.1 ç¾æœ‰ä½¿ç”¨å ´æ™¯åŠŸèƒ½éœ€æ±‚

| ä½¿ç”¨å ´æ™¯ | å¿…éœ€åŠŸèƒ½ | Supabase | Cloudinary |
|---------|---------|----------|----------|
| **æ–‡ä»¶ä¸Šå‚³** (PDF/DOCX) | å„²å­˜åŸæª”ã€å…¬é–‹è¨ªå• | âœ… | âŒ (ä¸é©åˆ) |
| **AI ç”Ÿæˆåœ–ç‰‡** | å„²å­˜ URLã€å±•ç¤º | âœ… | âœ… |
| **æ–‡ä»¶è§£æåœ–ç‰‡** | å„²å­˜ URLã€å±•ç¤º | âœ… | âœ… |
| **OnlyOffice é™„ä»¶** | å„²å­˜ã€Office Viewer å­˜å– | âœ… | âŒ (ä¸æ”¯æ´) |
| **å°ˆæ¡ˆåœ–ç‰‡ç´ æåº«** | å„²å­˜ã€ä¾› AI åƒè€ƒ | âœ… | âœ… |

### 5.2 æœªä¾†å¯èƒ½éœ€æ±‚ (YAGNI åˆ†æ)

| é€²éšåŠŸèƒ½ | å¯èƒ½æ€§ | Cloudinary å„ªå‹¢ | æ›¿ä»£æ–¹æ¡ˆ |
|---------|-------|----------------|---------|
| **éŸ¿æ‡‰å¼åœ–ç‰‡** (å¤šå°ºå¯¸) | ä½ (å¾Œå°ç³»çµ±ï¼Œéå…¬é–‹ç¶²ç«™) | è‡ªå‹•ç”¢ç”Ÿ | å‰ç«¯ `srcset` + Sharp.js |
| **åœ–ç‰‡å£“ç¸®** | ä¸­ (ç¯€çœé »å¯¬) | è‡ªå‹•å„ªåŒ– | ä¸Šå‚³å‰ç”¨ Sharp.js å£“ç¸® |
| **WebP è½‰æ›** | ä¸­ (ç¾ä»£ç€è¦½å™¨æ”¯æ´) | URL åƒæ•¸è‡ªå‹•è½‰ | ä¸Šå‚³å‰è½‰æ› + å‰ç«¯ `<picture>` |
| **AI èƒŒæ™¯ç§»é™¤** | æ¥µä½ (æ¨™æ¡ˆæ–‡ä»¶ä¸éœ€è¦) | Cloudinary AI | Azure Vision API (æŒ‰éœ€) |
| **æ™ºæ…§è£åˆ‡** | æ¥µä½ | Cloudinary AI | æ‰‹å‹•è£åˆ‡ |

**çµè«–**: å¤§éƒ¨åˆ†ã€Œé€²éšåŠŸèƒ½ã€åœ¨æ¨™æ¡ˆåŠ©æ‰‹ç³»çµ±ä¸­ä½¿ç”¨ç‡æ¥µä½ï¼Œä¸å€¼å¾—ç‚ºæ­¤å¢åŠ è¤‡é›œåº¦ã€‚

---

## 6. æˆæœ¬è©³ç´°è©¦ç®— (Cost Analysis)

### 6.1 ä½¿ç”¨é‡å‡è¨­

**ä¿å®ˆä¼°ç®—** (ç¬¬ä¸€å¹´):
- æ´»èºå°ˆæ¡ˆ: 100 å€‹
- æ¯å°ˆæ¡ˆåœ–ç‰‡: 20 å¼µ (AI ç”Ÿæˆ + è§£æ)
- åœ–ç‰‡å¤§å°: å¹³å‡ 500KB
- ç¸½å„²å­˜: 100 Ã— 20 Ã— 0.5MB = 1GB
- æ¯å¼µåœ–æ¯æœˆæŸ¥çœ‹: 10 æ¬¡
- ç¸½é »å¯¬: 1GB Ã— 10 = 10GB/æœˆ

**æˆé•·é æ¸¬** (ç¬¬äºŒå¹´):
- æ´»èºå°ˆæ¡ˆ: 500 å€‹
- ç¸½å„²å­˜: 5GB
- ç¸½é »å¯¬: 50GB/æœˆ

### 6.2 æ–¹æ¡ˆæˆæœ¬å°æ¯”

| æ–¹æ¡ˆ | ç¬¬ä¸€å¹´æœˆè²» | ç¬¬äºŒå¹´æœˆè²» | å‚™è¨» |
|------|-----------|-----------|------|
| **A: Supabase Free** | $0 | ä¸é©ç”¨ (è¶…é »å¯¬) | åƒ…é©åˆ Demo éšæ®µ |
| **A: Supabase Pro** | $25 | $25 | 100GB å„²å­˜ + 250GB é »å¯¬ |
| **B: Cloudinary** | $5-8 | $15-25 | éš¨ç”¨é‡å¢é•·ï¼Œé›£é æ¸¬ |
| **C: æ··åˆ** | $30-35 | $40-50 | å…©å¥—ç³»çµ±æˆæœ¬ç–ŠåŠ  |
| **D: è‡ªå»º** | $0 (VM å·²æœ‰) | $0 | éš±æ€§æˆæœ¬: ç¶­è­·å·¥æ™‚ |

**æˆæœ¬çµè«–**:
- æ—©æœŸ (< 2GB é »å¯¬): Supabase Free æœ€å„ª
- ä¸­æœŸ (2-50GB): Supabase Pro æœ€å„ª
- å¾ŒæœŸ (> 250GB): è€ƒæ…® Cloudinary æˆ–è‡ªå»º CDN

---

## 7. æ¶æ§‹æ±ºç­– (Decision)

### âœ… é¸æ“‡æ–¹æ¡ˆ A: ç¶­æŒ Supabase Storage (All-in-One)

**æ±ºç­–ç†ç”±**:

1. **ç¬¦åˆ SOLID åŸå‰‡ - å–®ä¸€è·è²¬**
   - Supabase å·²æ‰¿æ“”ã€Œè³‡æ–™å„²å­˜ã€è·è²¬ï¼Œæ“´å±•åˆ°ã€Œæª”æ¡ˆå„²å­˜ã€æ˜¯è‡ªç„¶å»¶ä¼¸
   - ä¸å¢åŠ é¡å¤–æŠ½è±¡å±¤ï¼Œé™ä½è¤‡é›œåº¦

2. **ç¬¦åˆ YAGNI åŸå‰‡ - é¿å…éåº¦è¨­è¨ˆ**
   - ç›®å‰ç„¡è­‰æ“šé¡¯ç¤º Supabase Storage æ•ˆèƒ½ä¸è¶³
   - é€²éšåœ–ç‰‡åŠŸèƒ½ä½¿ç”¨ç‡ä½ï¼Œä¸å€¼å¾—ç‚ºæ­¤å¢åŠ ä¾è³´

3. **ç¬¦åˆ 12-Factor App - æœ€å°åŒ–å¤–éƒ¨ä¾è³´**
   - æ¸›å°‘ç¬¬ä¸‰æ–¹æœå‹™ä¾è³´ï¼Œé™ä½å–®é»æ•…éšœé¢¨éšª
   - ç°¡åŒ– API Keyã€èªè­‰ã€ç›£æ§ç®¡ç†

4. **æˆæœ¬æ•ˆç›Šæœ€å„ª**
   - Supabase Pro ($25/æœˆ) å¯æ”¯æ’ç¬¬ä¸€å¹´æˆé•·
   - é¿å… Cloudinary éš±æ€§æˆæœ¬ (è½‰æ›é…é¡ã€è¶…é‡è²»ç”¨)

5. **æŠ€è¡“å‚µå‹™æœ€ä½**
   - é›¶é·ç§»æˆæœ¬ï¼Œåœ˜éšŠå¯å°ˆæ³¨æ ¸å¿ƒæ¥­å‹™åŠŸèƒ½é–‹ç™¼
   - æœªä¾†è‹¥çœŸéœ€è¦ï¼Œä»å¯ç„¡ç—›é·ç§» (Supabase Storage æ˜¯æ¨™æº– S3 API)

### ğŸš« ä¸é¸æ“‡å…¶ä»–æ–¹æ¡ˆçš„åŸå› 

- **æ–¹æ¡ˆ B/C (Cloudinary)**:
  - âŒ éæ—©å„ªåŒ– (Premature Optimization)
  - âŒ å¢åŠ ä¸å¿…è¦è¤‡é›œåº¦
  - âŒ ROI ä¸æ˜ç¢º (æ•ˆèƒ½æå‡ < 30%ï¼Œä½†é–‹ç™¼æˆæœ¬ > 50 äººæ™‚)

- **æ–¹æ¡ˆ D (è‡ªå»º)**:
  - âŒ é•åã€Œå°ˆæ³¨æ ¸å¿ƒæ¥­å‹™ã€åŸå‰‡
  - âŒ ç¶­è­·è² æ“”éé«˜

---

## 8. å¯¦æ–½è¨ˆåŠƒ (Implementation Plan)

### éšæ®µ 0: ç¾ç‹€å„ªåŒ– (0-1 å€‹æœˆ)

**ç›®æ¨™**: å„ªåŒ–ç¾æœ‰ Supabase Storage ä½¿ç”¨ï¼Œå»¶é²é·ç§»éœ€æ±‚

**è¡Œå‹•**:
1. **åœ–ç‰‡å£“ç¸®**: ä¸Šå‚³å‰ç”¨ Sharp.js å£“ç¸®è‡³ 80% å“è³ªï¼Œç¯€çœ 30-50% å„²å­˜
   ```typescript
   // åœ¨ UploadZone.tsx ä¸Šå‚³å‰åŠ å…¥
   const compressedFile = await sharp(file)
     .resize({ width: 1920, withoutEnlargement: true })
     .jpeg({ quality: 80 })
     .toBuffer();
   ```

2. **CDN å¿«å–å„ªåŒ–**: è¨­å®š Supabase Storage å¿«å–é ­
   ```sql
   -- åœ¨ storage.objects è¡¨è¨­å®š cache_control
   UPDATE storage.objects
   SET cache_control = 'public, max-age=31536000'
   WHERE bucket_id = 'raw-files';
   ```

3. **ç›£æ§**: è¨­ç½® Supabase Storage ç”¨é‡å‘Šè­¦
   - å„²å­˜ç”¨é‡ > 500MB æ™‚é€šçŸ¥
   - é »å¯¬ç”¨é‡ > 1.5GB æ™‚é€šçŸ¥ (Free æ–¹æ¡ˆ 2GB é™åˆ¶)

**é æœŸæ•ˆæœ**:
- å„²å­˜ç”¨é‡æ¸›å°‘ 40%
- é »å¯¬ç”¨é‡æ¸›å°‘ 30%
- å»¶é²é·ç§»éœ€æ±‚è‡³å°‘ 6 å€‹æœˆ

### éšæ®µ 1: è©•ä¼°è§¸ç™¼æ¢ä»¶ (æŒçºŒç›£æ§)

**ä½•æ™‚é‡æ–°è©•ä¼°é·ç§»**:
- âš ï¸ Supabase Pro é »å¯¬ > 200GB/æœˆ (æ¥è¿‘ 250GB é™åˆ¶)
- âš ï¸ å„²å­˜ > 80GB (æ¥è¿‘ 100GB é™åˆ¶)
- âš ï¸ ç”¨æˆ¶åé¥‹åœ–ç‰‡è¼‰å…¥æ…¢ (> 2s)
- âš ï¸ æ–°åŠŸèƒ½æ˜ç¢ºéœ€è¦é€²éšåœ–ç‰‡è™•ç† (å¦‚é›»å•†ç”¢å“åœ–)

### éšæ®µ 2: æ¼¸é€²å¼é·ç§» (è‹¥è§¸ç™¼)

**é·ç§»ç­–ç•¥**: å¢é‡é·ç§» (Incremental Migration)
1. æ–°ä¸Šå‚³èµ° Cloudinaryï¼ŒèˆŠæª”æ¡ˆä¸å‹•
2. å‰ç«¯è‡ªå‹•åˆ¤æ–· URL å‰ç¶´ (`supabase.co` vs `cloudinary.com`)
3. èƒŒæ™¯ Job é€æ­¥é·ç§»èˆŠæª”æ¡ˆ
4. ç›£æ§ Cloudinary æˆæœ¬èˆ‡æ•ˆèƒ½
5. ç¢ºèªç©©å®šå¾Œé—œé–‰ Supabase Storage

---

## 9. é¢¨éšªèˆ‡ç·©è§£ (Risks & Mitigation)

| é¢¨éšª | å¯èƒ½æ€§ | å½±éŸ¿ | ç·©è§£æªæ–½ |
|------|-------|------|---------|
| **Supabase Storage æ•ˆèƒ½ä¸è¶³** | ä½ | ä¸­ | ç›£æ§è¼‰å…¥æ™‚é–“ï¼Œè‹¥ > 2s å‰‡å„ªåŒ–æˆ–é·ç§» |
| **Supabase æœå‹™ä¸­æ–·** | æ¥µä½ | é«˜ | Supabase SLA 99.9%ï¼Œå¯æ¥å— |
| **é »å¯¬è¶…æ¨™** | ä¸­ | ä½ | å£“ç¸®åœ–ç‰‡ + å‡ç´š Pro æ–¹æ¡ˆ |
| **æœªä¾†éœ€è¦ AI åœ–ç‰‡è™•ç†** | ä½ | ä¸­ | æŒ‰éœ€ä½¿ç”¨ Azure Vision APIï¼Œä¸ç¶å®š Cloudinary |
| **ä¾›æ‡‰å•†é–å®š** | ä½ | ä¸­ | Supabase Storage ç›¸å®¹ S3 APIï¼Œå¯ç„¡ç—›é·ç§» |

---

## 10. åº¦é‡æŒ‡æ¨™ (Metrics)

**KPI å®šç¾©**:
1. **åœ–ç‰‡è¼‰å…¥æ™‚é–“** (P95): < 1.5s
2. **å„²å­˜æˆæœ¬**: < $30/æœˆ
3. **é »å¯¬æˆæœ¬**: < $5/æœˆ
4. **ä¸Šå‚³æˆåŠŸç‡**: > 99%
5. **CDN å¿«å–å‘½ä¸­ç‡**: > 90%

**ç›£æ§å·¥å…·**:
- Supabase Dashboard (å…§å»ºç”¨é‡ç›£æ§)
- Sentry (å‰ç«¯æ•ˆèƒ½ç›£æ§)
- Google Analytics (Core Web Vitals)

---

## 11. åƒè€ƒè³‡æ–™ (References)

### æ•ˆèƒ½ç ”ç©¶
- [Supabase Storage æ•ˆèƒ½æ¸¬è©¦](https://supabase.com/docs/guides/storage/cdn)
- [Cloudinary vs S3 æ•ˆèƒ½æ¯”è¼ƒ](https://cloudinary.com/documentation/performance_and_optimization)

### æˆæœ¬è¨ˆç®—æ©Ÿ
- [Supabase Pricing](https://supabase.com/pricing)
- [Cloudinary Pricing Calculator](https://cloudinary.com/pricing)

### æ¶æ§‹æ¨¡å¼
- [12-Factor App](https://12factor.net/)
- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID)
- [YAGNI Principle](https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it)

---

## 12. é™„éŒ„: ç¨‹å¼ç¢¼ç¯„ä¾‹

### A. ç¾æœ‰ä¸Šå‚³é‚è¼¯ (Supabase)
```typescript
// ç¾ç‹€: UploadZone.tsx (Line 96-98)
const { error: uploadError } = await supabase.storage
    .from('raw-files')
    .upload(filePath, file)
```

### B. è‹¥æ¡ç”¨ Cloudinary éœ€ä¿®æ”¹ç‚º
```typescript
// é·ç§»å¾Œ: éœ€è¦é‡å¯«
import { v2 as cloudinary } from 'cloudinary';

const result = await cloudinary.uploader.upload(file, {
  folder: 'ai-tender-assistant',
  resource_type: 'auto',
  public_id: `${projectId}/${Date.now()}`
});
// ç„¶å¾Œå„²å­˜ result.secure_url åˆ°è³‡æ–™åº«
```

### C. åœ–ç‰‡å£“ç¸®å„ªåŒ– (å»ºè­°å¯¦æ–½)
```typescript
// åœ¨ä¸Šå‚³å‰åŠ å…¥
import sharp from 'sharp';

async function compressImage(file: File): Promise<Buffer> {
  const buffer = await file.arrayBuffer();
  return sharp(Buffer.from(buffer))
    .resize({ width: 1920, withoutEnlargement: true })
    .jpeg({ quality: 80, progressive: true })
    .toBuffer();
}

// åœ¨ uploadFiles å‡½æ•¸ä¸­ä½¿ç”¨
const compressedBuffer = await compressImage(file);
const compressedFile = new File([compressedBuffer], file.name, { type: 'image/jpeg' });
```

---

## 13. æ±ºç­–ç¢ºèª (Confirmation)

**æœ€çµ‚æ±ºç­–**: âœ… æ–¹æ¡ˆ A - ç¶­æŒ Supabase Storage

**ä¸‹ä¸€æ­¥è¡Œå‹•**:
1. âœ… å¯¦æ–½éšæ®µ 0 å„ªåŒ– (åœ–ç‰‡å£“ç¸® + CDN å¿«å–)
2. âœ… è¨­ç½®ç›£æ§å‘Šè­¦
3. âŒ æš«ä¸é·ç§»è‡³ Cloudinary
4. ğŸ“… 6 å€‹æœˆå¾Œé‡æ–°è©•ä¼° (2026-07-29)

**ç°½æ ¸**:
- æ¶æ§‹å¸«: Leo (2026-01-29)
- å¾…ç¢ºèª: å°ˆæ¡ˆç¶“ç†ã€æŠ€è¡“è² è²¬äºº

---

**è®Šæ›´æ­·å²**:
- 2026-01-29: åˆç‰ˆï¼Œå»ºè­°ç¶­æŒ Supabase Storage
