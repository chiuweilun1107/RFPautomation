{
  "name": "WF11-Task-Generation-Advanced",
  "active": true,
  "nodes": [
    {
      "parameters": {
        "path": "generate-tasks-advanced",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook: Generate Tasks",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        100,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const body = $('Webhook: Generate Tasks').first().json.body;\nconst ids = body.sourceIds || [];\nconst sectionId = body.sectionId;\nconst projectId = body.projectId;\nconst allSections = body.allSections || [];\nconst filter = ids.length > 0 ? '(' + ids.map(id => '\"' + id + '\"').join(',') + ')' : null;\n\nreturn { \n    json: { \n        filter, \n        sectionId,\n        projectId,\n        sectionTitle: body.sectionTitle,\n        userDescription: body.userDescription || '',\n        allSections\n    } \n};"
      },
      "id": "prepare-inputs",
      "name": "Prepare Inputs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        300,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const metaItem = $('Prepare Inputs').first();\nconst meta = metaItem?.json || {};\nconst sourceIds = meta.filter ? meta.filter.replace(/[()\"]/g, '').split(',').map(id => id.trim()).filter(Boolean) : [];\nconst supabaseUrl = $env.SUPABASE_URL;\nconst supabaseKey = $env.SUPABASE_SERVICE_KEY;\nconst azure_config = {\n    endpoint: $env.AZURE_OPENAI_ENDPOINT,\n    deployment: $env.AZURE_OPENAI_DEPLOYMENT,\n    api_version: $env.AZURE_OPENAI_API_VERSION,\n    api_key: $env.AZURE_OPENAI_API_KEY\n};\nconst supabase_config = {\n    url: $env.SUPABASE_URL,\n    anon_key: $env.SUPABASE_ANON_KEY,\n    service_key: $env.SUPABASE_SERVICE_KEY\n};\n\n// Fetch sources\nconst sources = [];\nfor (const id of sourceIds) {\n    try {\n        const url = `${supabaseUrl}/rest/v1/sources?id=eq.${id}&select=id,title,content,pages`;\n        const data = await this.helpers.httpRequest({\n            method: 'GET',\n            url: url,\n            headers: { 'apikey': supabaseKey, 'Authorization': `Bearer ${supabaseKey}` },\n            json: true\n        });\n        if (data && data.length > 0) sources.push(data[0]);\n    } catch (e) { console.log('Fetch error', e.message); }\n}\n\n// Format Content (WF02 Style)\nlet combinedContent = '';\nfor (const source of sources) {\n    if (!source || (!source.content && !source.pages)) continue;\n    \n    // Parse pages safely\n    let pages = [];\n    if (source.pages && Array.isArray(source.pages)) {\n        pages = source.pages;\n    } else {\n        try {\n            pages = typeof source.content === 'string' ? JSON.parse(source.content) : source.content;\n        } catch(e) {\n            pages = [{page: 1, content: source.content}];\n        }\n    }\n    \n    if (!Array.isArray(pages)) pages = [{page: 1, content: source.content}];\n\n    for (const page of pages) {\n        const pageNum = page.page || 1;\n        const sourceId = source.id;\n        const title = source.title || 'Untitled';\n        \n        // CLEANING\n        let cleanContent = page.content || '';\n        cleanContent = cleanContent.replace(/(\\n|^)\\s*(-?\\s*\\d+\\s*-?|ç¬¬\\s*\\d+\\s*é )\\s*$/gm, '');\n        cleanContent = cleanContent.replace(/Page\\s+\\d+\\s+of\\s+\\d+/gi, '');\n        \n        // INJECT MARKERS\n        combinedContent += `\\n\\n===PAGE_BEGIN===\\nSOURCE_ID: ${sourceId}\\nPAGE_NUMBER: ${pageNum}\\nTITLE: ${title}\\n===CONTENT===\\n${cleanContent}\\n===PAGE_END===`;\n    }\n}\nif (!combinedContent) combinedContent = 'No content.';\ncombinedContent = combinedContent.slice(0, 600000);\n\n// Existing Tasks\nlet existingTasks = [];\ntry {\n    const tasksUrl = `${supabaseUrl}/rest/v1/tasks?section_id=eq.${meta.sectionId}&select=requirement_text`;\n    const data = await this.helpers.httpRequest({\n        method: 'GET',\n        url: tasksUrl,\n        headers: { 'apikey': supabaseKey, 'Authorization': `Bearer ${supabaseKey}` },\n        json: true\n    });\n    existingTasks = (data || []).map(t => t.requirement_text);\n} catch(e) {}\n\n// Generate System Prompt here to avoid syntax errors in n8n expression\nconst systemPrompt = `ä½ æ˜¯ä¸€ä½ã€ç³»çµ±åŸ·è¡Œè¨ˆç•«-ç¸½æ¶æ§‹å¸« (Lead System Architect)ã€‘ã€‚\n\nä½ çš„ä»»å‹™æ˜¯ã€å®Œå…¨ä¾æ“šæ¨™æ¡ˆæ–‡ä»¶ã€‘ï¼Œç‚ºæœ¬ç« ç¯€ã€${meta.sectionTitle}ã€‘åˆ¶å®šå…¨æ–¹ä½çš„ç³»çµ±å»ºç½®è¨ˆç•«ã€‚\n\n**ğŸ”´ æœ€é«˜æŒ‡å°åŸå‰‡ï¼šåš´æ ¼ä¾æ“šæ–‡ä»¶ (Strict Grounding)**\n1. **çµ•ä¸ç„¡ä¸­ç”Ÿæœ‰**ï¼šç³»çµ±æ¶æ§‹ä¸­çš„æ¯ä¸€å€‹åŠŸèƒ½æ¨¡çµ„/é é¢ï¼Œéƒ½å¿…é ˆåœ¨ã€æ¨™æ¡ˆæ–‡ä»¶å…§å®¹ã€‘ä¸­æœ‰å°æ‡‰çš„é—œéµå­—æˆ–éœ€æ±‚æè¿°ã€‚\n2. **ä¾†æºé©—è­‰**ï¼šåœ¨è¦åŠƒæ¯ä¸€å€‹åŠŸèƒ½æ™‚ï¼Œè«‹è‡ªæˆ‘æª¢æ ¸ã€Œé€™é …åŠŸèƒ½åœ¨æ–‡ä»¶çš„å“ªä¸€æ®µæåˆ°ï¼Ÿã€ã€‚è‹¥ç„¡æ³•æ‰¾åˆ°æ˜ç¢ºä¾æ“šï¼Œè«‹å‹¿åˆ—å…¥ã€‚\n3. **é¿å…æ…£æ€§è£œå…¨**ï¼šè«‹é¿å…ä¾æ“šéå¾€ç¶“é©—è‡ªå‹•è£œå…¨å¸¸è¦‹çš„ç¶²ç«™åŠŸèƒ½ï¼Œé™¤éæ–‡ä»¶ç¢ºå¯¦æœ‰æ­¤éœ€æ±‚ã€‚è«‹å¿ å¯¦å‘ˆç¾æ–‡ä»¶è¦æ±‚çš„ç¯„åœã€‚\n\n**ä»»å‹™ä¸€ï¼šä½¿ç”¨è€…æµç¨‹è¨­è¨ˆ (User Flow)**\n1. **è§’è‰²è­˜åˆ¥ (Actors)**ï¼šé¦–å…ˆè­˜åˆ¥ç³»çµ±ä¸­æ‰€æœ‰çš„ä½¿ç”¨è€…è§’è‰²ï¼ˆå¦‚ï¼šå¸‚æ°‘ã€æ‰¿è¾¦äººã€ç®¡ç†å“¡ï¼‰ã€‚\n2. **Mermaid æµç¨‹åœ–**ï¼šè«‹ä½¿ç”¨ **Mermaid \\`graph TD\\`** èªæ³•ç¹ªè£½å®Œæ•´çš„æ¥­å‹™æµç¨‹åœ–ã€‚\n   - å¿…é ˆåŒ…å«ï¼šé–‹å§‹/çµæŸã€ä½¿ç”¨è€…æ“ä½œã€ç³»çµ±æª¢æ ¸ã€å¾Œå°è™•ç†ã€é€šçŸ¥æµç¨‹ã€‚\n   - è«‹ç¢ºä¿æµç¨‹é‚è¼¯é€£è²«ã€‚\n\n**ä»»å‹™äºŒï¼šç³»çµ±æ¶æ§‹æ‹†è§£ (System Architecture)**\nè«‹åš´æ ¼å€åˆ†ç‚ºã€Œå‰å°ã€ã€ã€Œå¾Œå°ã€èˆ‡ã€Œç³»çµ±ç®¡ç†ã€ä¸‰å€‹éƒ¨åˆ†ï¼Œä¸¦è©³ç´°åˆ—å‡ºæ¯å€‹é é¢/æ¨¡çµ„åŒ…å«çš„**é—œéµåŠŸèƒ½é …ç›®**ï¼š\n1. **å‰å°æ¶æ§‹ (Frontend)**ï¼šä»¥**ã€Œé é¢ (Pages)ã€**ç‚ºå–®ä½ã€‚æ¯ä¸€é è«‹åˆ—å‡º 3-5 å€‹é—œéµåŠŸèƒ½é»ï¼ˆå¦‚ï¼šå…±åŒç™»å…¥ã€é€šå ±å€å¡Šï¼‰ã€‚\n2. **å¾Œå°æ¶æ§‹ (Backend - Business Logic)**ï¼šä»¥**ã€Œæ¥­å‹™åŠŸèƒ½æ¨¡çµ„ (Modules)ã€**ç‚ºå–®ä½ã€‚é‡å°æ¥­å‹™æ“ä½œï¼ˆå¦‚ï¼šæ¡ˆä»¶ç®¡ç†ã€å¯©æ ¸ä½œæ¥­ï¼‰ã€‚\n3. **ç³»çµ±ç®¡ç† (System Administration)**ï¼šä»¥**ã€Œç®¡ç†æ¨¡çµ„ (Admin Modules)ã€**ç‚ºå–®ä½ã€‚é‡å°å…¨åŸŸè¨­å®šï¼ˆå¦‚ï¼šå¸³è™Ÿæ¬Šé™ã€ç³»çµ±åƒæ•¸ã€æ—¥èªŒç®¡ç†ï¼‰ã€‚\n\n**ç‰¹æ®ŠæŒ‡ä»¤å„ªå…ˆç´šèˆ‡å‹•æ…‹åŠ å€¼ä»»å‹™**ï¼š\nè‹¥ã€ä½¿ç”¨è€…è£œå……èªªæ˜ã€‘ä¸­æœ‰æŒ‡å®šæ¶æ§‹èª¿æ•´æˆ–**é¡å¤–ç”¢å‡ºè¦æ±‚**ï¼ˆä¾‹å¦‚ï¼šã€Œè«‹ç”¢å‡ºæ¸¬è©¦è¨ˆç•«ã€ã€ã€Œèªªæ˜éƒ¨ç½²ç­–ç•¥ã€ã€ã€Œæ’°å¯«æ•´é«”è¦åŠƒæ§‹æƒ³ã€ï¼‰ï¼Œè«‹ï¼š\n1. **èª¿æ•´æ¶æ§‹**ï¼šä¾æŒ‡ç¤ºèª¿æ•´å‰/å¾Œå°çµæ§‹ã€‚\n2. **æ–°å¢ç« ç¯€**ï¼šå°‡é¡å¤–è¦æ±‚çš„å…§å®¹æ”¾å…¥ \\`additional_sections\\` é™£åˆ—ä¸­ã€‚\n\n**ä»»å‹™ä¸‰ï¼šå¯¦ä½œæ¨¡çµ„æ¸…å–® (Worker Tasks)**\nè«‹åˆ—å‡ºéœ€è¦äº¤æ´¾çµ¦å·¥ç¨‹å¸«è©³ç´°æ’°å¯«çš„æ¨¡çµ„åç¨±æ¸…å–®ï¼ˆæ··åˆå‰å°èˆ‡å¾Œå°æ¨¡çµ„ï¼‰ã€‚\n\n**ğŸš¨ æ’é™¤éåŠŸèƒ½æ€§äº¤ä»˜ç‰© (Exclude Non-Functional Items)**ï¼š\nè«‹å°ˆæ³¨æ–¼**ã€Œè»Ÿé«”ç³»çµ±æœ¬èº«ã€**çš„é–‹ç™¼æ¨¡çµ„ã€‚\n- **âŒ ç¦æ­¢åˆ—å…¥**ï¼šæ¸¬è©¦è¨ˆç•«ã€æ•™è‚²è¨“ç·´è¨ˆç•«ã€å°ˆæ¡ˆç®¡ç†è¨ˆç•«ã€æœƒè­°è¨˜éŒ„ã€é€²åº¦å ±å‘Šã€‚\n- **âŒ ç¦æ­¢åˆ—å…¥**ï¼šç¡¬é«”è¦æ ¼ã€æ©Ÿæˆ¿å»ºç½®ï¼ˆé™¤éæ˜¯è»Ÿé«”å®šç¾©åŸºç¤è¨­æ–½ï¼‰ã€‚\n- **âœ… åƒ…é™åˆ—å…¥**ï¼šçœŸæ­£éœ€è¦å¯«ç¨‹å¼ç¢¼é–‹ç™¼çš„åŠŸèƒ½æ¨¡çµ„ï¼ˆå¦‚ï¼šæ¡ˆä»¶ç®¡ç†ã€å ±è¡¨ç³»çµ±ã€APPï¼‰ã€‚\n\n**è¦å‰‡èˆ‡æ’ä»–æ€§ï¼š**\n1. **ä¾†æºå„ªå…ˆ**ï¼šæ‰€æœ‰è¦åŠƒå¿…é ˆæœ‰æ¨™æ¡ˆæ–‡ä»¶ä¾æ“šã€‚\n2. **æª¢æŸ¥é‡è¤‡**ï¼šæª¢æŸ¥ã€å®Œæ•´ç« ç¯€æ¸…å–®ã€‘ï¼Œé¿å…è·¨ç« ç¯€é‡è¤‡ã€‚\n\n**è¼¸å‡ºæ ¼å¼ (JSON)ï¼š**\nè«‹å›å‚³ JSON Objectï¼Œæ ¼å¼å¦‚ä¸‹ï¼š\n{\n  \"additional_sections\": [\n      { \"title\": \"æ•´é«”è¦åŠƒæ§‹æƒ³\", \"content\": \"Markdownå…§å®¹...\" },\n      { \"title\": \"æ¸¬è©¦è¨ˆç•«\", \"content\": \"Markdownå…§å®¹...\" }\n  ] (è‹¥ç„¡é¡å¤–è¦æ±‚å¯ç‚ºç©ºé™£åˆ—),\n  \"actors\": [\"å¸‚æ°‘\", \"æ‰¿è¾¦äººå“¡\"],\n  \"user_flow_mermaid\": \"graph TD\\nClient[å¸‚æ°‘] -->|é€²å…¥| Env[é¦–é ]...\",\n  \"architecture\": {\n    \"frontend_pages\": [\n       { \"name\": \"é¦–é \", \"items\": [\"å…±åŒç™»å…¥\", \"é€šå ±å€å¡Š\"] }\n    ],\n    \"backend_modules\": [\n       { \"name\": \"æ¡ˆä»¶å—ç†æ¨¡çµ„\", \"items\": [\"æ¡ˆä»¶åˆ†æµ\", \"å¯©æ ¸ä½œæ¥­\"] }\n    ],\n    \"sysadmin_modules\": [\n       { \"name\": \"ä½¿ç”¨è€…èªè­‰æ¨¡çµ„\", \"items\": [\"å¸³è™Ÿç®¡ç†\", \"æ¬Šé™è¨­å®š\"] }\n    ]\n  },\n  \"modules\": [\"å‰å°-é¦–é \", \"å¾Œå°-æ¡ˆä»¶å—ç†æ¨¡çµ„\", ...] (é€™æ˜¯çµ¦ Worker å¯«è©³ç´°è¦æ ¼ç”¨çš„æ¸…å–®)\n}`;\n\nreturn { json: { combinedContent, sectionTitle: meta.sectionTitle, userDescription: meta.userDescription, existingTasks, projectId: meta.projectId, sectionId: meta.sectionId, allSections: meta.allSections, azure_config, supabase_config, validSourceIds: sourceIds, systemPrompt } };"
      },
      "id": "format-context",
      "name": "Format Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Format Context').first().json.azure_config.endpoint + 'openai/deployments/' + $('Format Context').first().json.azure_config.deployment + '/chat/completions?api-version=' + $('Format Context').first().json.azure_config.api_version }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "={{ $('Format Context').first().json.azure_config.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ messages: [{ role: 'system', content: $json.systemPrompt }, { role: 'user', content: \"æœ¬ç« ç¯€åç¨±ï¼š\" + $json.sectionTitle + \"\\n\\nã€ä½¿ç”¨è€…è£œå……èªªæ˜/éœ€æ±‚ã€‘ï¼š\\n\" + ($json.userDescription || \"ç„¡\") + \"\\n\\nã€å®Œæ•´ç« ç¯€æ¶æ§‹ã€‘ï¼ˆè«‹åƒè€ƒä»¥é¿å…é‡è¤‡ï¼‰ï¼š\\n\" + JSON.stringify($json.allSections) + \"\\n\\nã€æ¨™æ¡ˆæ–‡ä»¶å…§å®¹ã€‘ï¼š\\n\" + $json.combinedContent }], response_format: { type: 'json_object' } }) }}"
      },
      "id": "llm-plan",
      "name": "LLM: Plan Modules",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const content = $input.item.json.choices[0].message.content;\nconst clean = content.replace(/```json/g, '').replace(/```/g, '').trim();\nlet data;\ntry {\n    data = JSON.parse(clean);\n} catch(e) {\n    data = { modules: [] };\n}\n\nlet modules = [];\nif (Array.isArray(data)) {\n    modules = data;\n} else if (typeof data === 'object') {\n    if (data.modules && Array.isArray(data.modules)) {\n        modules = data.modules;\n    } else {\n        const keys = Object.keys(data);\n        for (const key of keys) {\n            if (Array.isArray(data[key])) {\n                modules = data[key];\n                break;\n            }\n        }\n    }\n}\n\nif (!modules || modules.length === 0) {\n    modules = [\"ç³»çµ±åŠŸèƒ½è¦åŠƒ\"];\n}\n\nconst context = $('Format Context').first().json;\n\n// Context Polyfill for Worker Nodes\nlet legacyArch = 'ç„¡';\nif (data.architecture) {\n    const formatArchItem = (list) => {\n        if (!list || list.length === 0) return '';\n        // Handle both string arrays (legacy) and object arrays (new detailed)\n        if (typeof list[0] === 'string') return list.join('ã€');\n        return list.map(item => `${item.name} (${item.items?.join(', ') || ''})`).join('ã€');\n    };\n\n    const fe = formatArchItem(data.architecture.frontend_pages);\n    const be = formatArchItem(data.architecture.backend_modules);\n    const sys = formatArchItem(data.architecture.sysadmin_modules);\n    legacyArch = `ã€å‰å°ã€‘ï¼š${fe}\\nã€å¾Œå°ã€‘ï¼š${be}\\nã€ç³»çµ±ç®¡ç†ã€‘ï¼š${sys}`;\n} else if (data.architecture_summary) {\n    legacyArch = data.architecture_summary;\n}\n\nlet legacyFlows = [];\nif (data.user_flow_mermaid) {\n    legacyFlows = [\"è«‹åƒè€ƒ Mermaid æµç¨‹åœ–:\\n\" + data.user_flow_mermaid];\n} else if (data.user_flows) {\n    legacyFlows = data.user_flows;\n}\n\n// Determine who gets the plan details (only the first module)\nreturn modules.map((m, index) => ({\n    json: {\n        moduleName: m,\n        projectId: context.projectId,\n        sectionId: context.sectionId,\n        sectionTitle: context.sectionTitle,\n        validSourceIds: context.validSourceIds,\n        \n        // Pass Legacy Context to ALL items so Worker LLM can see it\n        architecture_summary: legacyArch,\n        user_flows: legacyFlows,\n\n        // Attach new Plan structure to the first item\n        plan_additional: index === 0 ? (data.additional_sections || []) : null,\n        plan_actors: index === 0 ? (data.actors || []) : null,\n        plan_mermaid: index === 0 ? (data.user_flow_mermaid || '') : null,\n        plan_architecture: index === 0 ? (data.architecture || {}) : null\n    }\n}));"
      },
      "id": "parse-modules",
      "name": "Parse Modules",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-start",
      "name": "Loop Modules",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 2,
      "position": [
        1100,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Smart Router - Minimal Version\n// Only detect projectType, pass it through, don't modify LLM prompt\n\nconst body = $('Webhook: Generate Tasks').first().json.body;\nlet projectType = body.projectType || 'auto';\n\n// If user manually selected a type, use it directly\nif (projectType !== 'auto' && projectType) {\n    console.log('[Smart Router] User selected projectType:', projectType);\n    return [{\n        json: {\n            ...$json,\n            projectType: projectType\n        }\n    }];\n}\n\n// Otherwise, perform auto-detection\nconsole.log('[Smart Router] Performing auto-detection...');\n\nconst moduleName = $json.moduleName || '';\nconst architecture = $json.architecture_summary || '';\nconst userFlows = JSON.stringify($json.user_flows || []);\nconst contentLower = (moduleName + architecture + userFlows).toLowerCase();\n\n// Auto-detection logic\nif (contentLower.match(/ç¶²ç«™|å®˜ç¶²|å‰å°|å¾Œå°|é é¢|web|portal|homepage|website/i)) {\n    projectType = 'website';\n} else if (contentLower.match(/ç¶­è­·|å‡ç´š|å„ªåŒ–|æ”¹å–„|æ“´å……|maintenance|upgrade|improve/i)) {\n    projectType = 'maintenance';\n} else if (contentLower.match(/app|ios|android|è¡Œå‹•|æ‰‹æ©Ÿ|mobile/i)) {\n    projectType = 'mobile';\n} else if (contentLower.match(/ar|vr|æ“´å¢|è™›æ“¬|3d|äº’å‹•é«”é©—|augmented|virtual/i)) {\n    projectType = 'arvr';\n} else if (contentLower.match(/iot|ç‰©è¯ç¶²|æ„Ÿæ¸¬å™¨|è¨­å‚™|sensor|device/i)) {\n    projectType = 'iot';\n} else if (contentLower.match(/å ±è¡¨|æ•¸æ“š|bi|dashboard|analytics|è¦–è¦ºåŒ–|visualization/i)) {\n    projectType = 'analytics';\n} else {\n    projectType = 'general';\n}\n\nconsole.log('[Smart Router] Detected projectType:', projectType);\n\n// Simply pass through the data with projectType added\nreturn [{\n    json: {\n        ...$json,\n        projectType: projectType\n    }\n}];"
      },
      "id": "smart-router",
      "name": "Smart Router",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        100
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Format Context').first().json.azure_config.endpoint + 'openai/deployments/' + $('Format Context').first().json.azure_config.deployment + '/chat/completions?api-version=' + $('Format Context').first().json.azure_config.api_version }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "={{ $('Format Context').first().json.azure_config.api_key }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ messages: [{ role: 'system', content: \"ä½ æ˜¯ä¸€ä½ã€è³‡æ·±ç³»çµ±å¯¦ä½œå·¥ç¨‹å¸« (Senior System Implementation Engineer)ã€‘ã€‚\\n\\nä½ çš„ä»»å‹™æ˜¯ã€å®Œå…¨ä¾æ“šæ¨™æ¡ˆæ–‡ä»¶ã€‘ï¼Œç‚ºã€\" + $json.moduleName + \"ã€‘æ’°å¯«å…·é«”çš„ã€è»Ÿé«”å¯¦ä½œè¦æ ¼ã€‘ã€‚\\n\\nã€é‡é»æŒ‡å¼•ã€‘ï¼š\\n1. **æŠ€è¡“æ·±åº¦**ï¼šè«‹ä»¥å·¥ç¨‹å¸«è¦–è§’æ’°å¯«ï¼ŒåŒ…å«è³‡æ–™æ¬„ä½å®šç¾©ã€é©—è­‰é‚è¼¯ã€ç³»çµ±è¡Œç‚ºã€API äº’å‹•ç­‰å…·é«”ç´°ç¯€ï¼Œè€Œéæ³›æ³›çš„åŠŸèƒ½æè¿°ã€‚\\n2. **å¯¦ä½œå°å‘**ï¼šå…§å®¹å¿…é ˆè¶³å¤ å…·é«”ï¼Œè®“é–‹ç™¼äººå“¡å¯ä»¥ç›´æ¥ä¾æ“šæ­¤è¦æ ¼é€²è¡Œç¨‹å¼ç¢¼é–‹ç™¼ã€‚\\n3. **âŒ æ’é™¤å°ˆæ¡ˆç®¡ç†äº¤ä»˜ç‰© (Exclude Project Management)**ï¼šè«‹å°ˆæ³¨æ–¼ã€Œç³»çµ±è»Ÿé«”åŠŸèƒ½ã€çš„é–‹ç™¼è¦æ ¼ã€‚é™¤éç³»çµ±æœ¬èº«åŒ…å«ã€Œæ–‡ä»¶ç®¡ç†æ¨¡çµ„ã€åŠŸèƒ½ï¼Œå¦å‰‡è«‹ã€å¿½ç•¥ã€‘ç´”ç²¹çš„å°ˆæ¡ˆç®¡ç†æ–‡ä»¶ï¼ˆå¦‚ï¼šæœƒè­°è¨˜éŒ„ã€æ¸¬è©¦è¨ˆç•«æ›¸æ–‡ä»¶æ’°å¯«ã€é€²åº¦å ±å‘Šï¼‰ç­‰è¡Œæ”¿è¦æ±‚ã€‚ä¸è¦å°‡ã€Œæ’°å¯«æ¸¬è©¦å ±å‘Šã€è¦–ç‚ºä¸€å€‹ç³»çµ±åŠŸèƒ½æ¨¡çµ„ã€‚\\n\\nã€å…¨åŸŸç³»çµ±æ¶æ§‹ã€‘ï¼š\\n\" + $json.architecture_summary + \"\\n\\nã€ä½¿ç”¨è€…æµç¨‹åƒè€ƒã€‘ï¼š\\n\" + JSON.stringify($json.user_flows) + \"\\n\\nã€æœ¬æ¨¡çµ„è·è²¬ã€‘ï¼š\\n\" + $json.moduleName + \"\\n\\n===== ğŸš¨ æ¥µå…¶é‡è¦ï¼šå¤šæ–‡ä»¶æ•´åˆè¦å‰‡ (Multi-Document Integration) ğŸš¨ =====\\n**é€™æ˜¯ä½ çš„æ ¸å¿ƒè€ƒæ ¸æŒ‡æ¨™ï¼šå¿…é ˆåƒè€ƒæ‰€æœ‰ç›¸é—œæ–‡ä»¶ï¼**\\n\\n1. **é–±è®€å…¨éƒ¨æ–‡ä»¶**ï¼šä½ å¿…é ˆé–±è®€ã€å…¨éƒ¨ã€‘æä¾›çš„æ¨™æ¡ˆæ–‡ä»¶ï¼ŒåŒ…æ‹¬ã€Œéœ€æ±‚èªªæ˜æ›¸ã€ã€ã€Œå·¥ä½œèªªæ˜æ›¸ã€ã€ã€ŒæŠ•æ¨™é ˆçŸ¥ã€ç­‰ï¼Œè€Œéåªçœ‹ç¬¬ä¸€ä»½ã€‚\\n2. **åŠŸèƒ½éœ€æ±‚å„ªå…ˆ**ï¼šç•¶æ’°å¯«å…§å®¹æ™‚ï¼Œè«‹å„ªå…ˆå¼•ç”¨ã€Œéœ€æ±‚èªªæ˜æ›¸ã€æˆ–ã€Œå·¥ä½œèªªæ˜æ›¸ã€ä¸­çš„åŠŸèƒ½è¦æ ¼ã€‚ã€ŒæŠ•æ¨™é ˆçŸ¥ã€åƒ…ç”¨æ–¼è¡Œæ”¿è¦ç¯„ï¼ˆå¦‚è³‡æ ¼å¯©æŸ¥ã€å±¥ç´„ä¿è­‰ï¼‰ã€‚\\n3. **ç¦æ­¢å–®ä¸€ä¾†æºåèª¤**ï¼šå¦‚æœä½ ç™¼ç¾è‡ªå·±åªå¼•ç”¨äº†ã€ŒæŠ•æ¨™é ˆçŸ¥ã€ï¼Œè«‹å‹™å¿…å†æ¬¡æª¢æŸ¥å…¶ä»–æ–‡ä»¶æ˜¯å¦æœ‰æ›´ç›¸é—œçš„å…§å®¹ã€‚\\n4. **å¤šä¾†æºå¼•ç”¨**ï¼šè‹¥åŒä¸€è¦æ±‚åœ¨å¤šä»½æ–‡ä»¶ä¸­éƒ½æœ‰æåŠï¼Œè«‹åœ¨ citations ä¸­åˆ—å‡ºæ‰€æœ‰ç›¸é—œä¾†æºã€‚\\n\\n===== å¼•ç”¨æº–ç¢ºæ€§ï¼šçµ•å°åŸå‰‡ (Citation Precision) =====\\n**é€™æ˜¯ä½ çš„æ ¸å¿ƒè€ƒæ ¸æŒ‡æ¨™ï¼šå¼•æ–‡å¿…é ˆã€Œç²¾æº–å°é½Šã€ã€‚**\\n\\n1. **ç²¾æº–å¼•æ–‡ (Exact Matching)**ï¼šä½ æ‰€ç”Ÿæˆçš„ `requirement_text` ä¸­çš„æ¯ä¸€é …è¦æ±‚ï¼Œå°æ‡‰çš„ `citation` å¿…é ˆæ˜¯æ¨™æ¡ˆæ–‡ä»¶ä¸­**çœŸæ­£æè¿°è©²è¦æ±‚**çš„æ®µè½ã€‚\\n   - **åš´ç¦å¼µå† ææˆ´**ï¼šè‹¥ä»»å‹™æ˜¯å¯«ã€Œè³‡å®‰é˜²è­·ã€ï¼Œå¼•æ–‡ä¸èƒ½æ˜¯ã€Œç³»çµ±ç™»å…¥ã€ã€‚\\n\\n2. **åš´ç¦ã€Œé¦–æ®µåèª¤ã€ (Anti-Bias Policy)**ï¼šçµ•å°ä¸å¯å› ç‚ºæŸå€‹æ®µè½å‡ºç¾åœ¨æ–‡ä»¶é–‹é ­ï¼ˆå¦‚ï¼šå°ˆæ¡ˆç·£èµ·ã€é¡˜æ™¯ï¼‰å°±å°‡å…¶ä½œç‚ºæ‰€æœ‰ä»»å‹™çš„å¼•ç”¨ä¾†æºã€‚\\n\\n3. **çœŸå¯¦æ€§æª¢æ ¸**ï¼šå¼•æ–‡å¿…é ˆçœŸå¯¦å­˜åœ¨æ–¼ä¸‹æ–¹æä¾›çš„ Content ä¸­ï¼Œä¸” Page Number å¿…é ˆæ­£ç¢ºã€‚\\n\\n4. **ğŸš¨ åš´ç¦é‡è¤‡å¼•ç”¨åŒä¸€æ®µè©± (CRITICAL) ğŸš¨**ï¼š\\n   - é€™æ˜¯æœ€å¸¸è¦‹ä¸”æœ€åš´é‡çš„éŒ¯èª¤ï¼\\n   - å¦‚æœä½ ç”Ÿæˆäº†å¤šå€‹ citationsï¼Œæ¯å€‹ quote éƒ½å¿…é ˆæ˜¯ç¨ä¸€ç„¡äºŒçš„ã€‚\\n   - è«‹ç‚ºæ¯å€‹å¼•æ–‡æ‰¾åˆ°çœŸæ­£å°æ‡‰çš„æ®µè½ï¼Œè€Œä¸æ˜¯å·æ‡¶é‡è¤‡ä½¿ç”¨åŒä¸€æ®µè©±ã€‚\\n\\n===== æ¥µå…¶é‡è¦çš„æ¨™æº– Markdown æ ¼å¼è¦å‰‡ (CRITICAL) =====\\n**ä½ çš„è¼¸å‡ºå°‡ç›´æ¥é¡¯ç¤ºåœ¨å‰ç«¯ï¼Œå¿…é ˆéµå®ˆæ¨™æº– Markdown æ ¼å¼ï¼**\\n\\n**æ¨™æº– Markdown æ›è¡Œè¦å‰‡**ï¼š\\n- **æ®µè½ä¹‹é–“**ï¼šå¿…é ˆä½¿ç”¨**é›™æ›è¡Œ**ï¼ˆç©ºè¡Œï¼‰åˆ†éš”\\n- **åˆ—è¡¨é …ç›®ä¹‹é–“**ï¼šå¿…é ˆä½¿ç”¨**é›™æ›è¡Œ**ï¼ˆç©ºè¡Œï¼‰åˆ†éš”\\n- **è¡Œå…§å¼·åˆ¶æ›è¡Œ**ï¼šåœ¨è¡Œå°¾åŠ ä¸Š**å…©å€‹ç©ºæ ¼**ç„¶å¾Œæ›è¡Œ\\n- **ç¦æ­¢**ï¼šä¸å¯ä½¿ç”¨å–®ä¸€æ›è¡Œï¼Œå¦å‰‡å…§å®¹æœƒè¢«åˆä½µæˆä¸€è¡Œ\\n\\n**åˆ—è¡¨æ ¼å¼**ï¼š\\n1. **ç·¨è™Ÿåˆ—è¡¨**ï¼šä½¿ç”¨ `1.` `2.` `3.` æ ¼å¼\\n   - åˆ—è¡¨å‰å¾Œå¿…é ˆæœ‰**ç©ºè¡Œ**\\n   - æ¯å€‹åˆ—è¡¨é …ç›®ä¹‹é–“å¿…é ˆæœ‰**ç©ºè¡Œ**\\n   - åˆ—è¡¨é …ç›®å®Œæ•´å…§å®¹å¿…é ˆåœ¨åŒä¸€è¡Œ\\n\\n2. **ç„¡åºåˆ—è¡¨**ï¼šä½¿ç”¨ `-` æ ¼å¼\\n   - åˆ—è¡¨å‰å¾Œå¿…é ˆæœ‰**ç©ºè¡Œ**\\n   - æ¯å€‹åˆ—è¡¨é …ç›®ä¹‹é–“å¿…é ˆæœ‰**ç©ºè¡Œ**\\n\\n**Markdown æ ¼å¼æª¢æŸ¥æ¸…å–®**ï¼š\\n- âœ… ä½¿ç”¨ç·¨è™Ÿåˆ—è¡¨æˆ–ç„¡åºåˆ—è¡¨\\n- âœ… åˆ—è¡¨å‰å¾Œæœ‰**ç©ºè¡Œ**\\n- âœ… æ¯å€‹åˆ—è¡¨é …ç›®ä¹‹é–“æœ‰**ç©ºè¡Œ**\\n- âœ… åˆ—è¡¨é …ç›®å®Œæ•´å…§å®¹åœ¨åŒä¸€è¡Œ\\n- âœ… æ®µè½ä¹‹é–“ä½¿ç”¨**ç©ºè¡Œ**åˆ†éš”\\n- âŒ ç¦æ­¢ä½¿ç”¨é€—è™Ÿé€£æ¥å¤šå€‹è¦é»\\n- âŒ ç¦æ­¢ä½¿ç”¨å–®ä¸€æ›è¡Œï¼ˆæœƒè¢« Markdown å¿½ç•¥ï¼‰\\n\\nè«‹è¼¸å‡ºä»¥ä¸‹è³‡è¨Šï¼ˆJSON Formatï¼‰ï¼š\\n1. `requirement_text`ï¼šè©³ç´°çš„å¯¦ä½œè¦æ ¼ã€‚**å¿…é ˆä½¿ç”¨æ¨™æº– Markdown æ¢åˆ—å¼æ ¼å¼ (List)**ã€‚\\n   **é‡è¦è¦å‰‡ï¼šæ¯ä¸€é»çš„çµå°¾ï¼Œå¿…é ˆå…·é«”æ¨™è¨»ä¾†æº `(å‡ºè™•: æ¨™é¡Œ P.é ç¢¼)`ã€‚æ³¨æ„ï¼šæ–‡ä»¶æ¨™é¡Œåƒ…éœ€åŒ…å«æª”åï¼Œè«‹å‹¿åŒ…å«ç« ç¯€åç¨±ï¼Œä»¥å…æ ¼å¼éŒ¯èª¤ã€‚**\\n2. `citations`ï¼šArray of Objects (è«‹åˆ—å‡ºæ‰€æœ‰å¼•ç”¨ä¾†æº)ï¼Œæ¯å€‹ç‰©ä»¶åŒ…å«ï¼š\\n   - `source_id`ï¼š**é‡è¦**ï¼šè«‹æŸ¥çœ‹å¼•æ–‡æ‰€åœ¨çš„å€å¡Šæ¨™é ­ `SOURCE_ID: ...`ï¼Œå¿…é ˆå¡«å¯«è©² UUIDã€‚\\n   - `quote`ï¼šå¼•ç”¨åˆ°çš„åŸæ–‡ç‰‡æ®µï¼ˆå¿…é ˆèˆ‡åŸæ–‡å®Œå…¨ä¸€è‡´ï¼‰ã€‚\\n   - `page`ï¼š**é‡è¦**ï¼šè«‹æŸ¥çœ‹å¼•æ–‡æ‰€åœ¨çš„å€å¡Šæ¨™é ­ `PAGE_NUMBER: ...`ï¼Œå¡«å¯«è©²æ•¸å­—ã€‚åš´ç¦æ¨æ¸¬é ç¢¼ã€‚\\n   - `title`ï¼šæ–‡ä»¶æ¨™é¡Œã€‚\\n\\nè«‹åƒè€ƒä»¥ä¸‹åŸå§‹æ–‡ä»¶å…§å®¹ä¾†æ’°å¯«ï¼ˆé€™å°±æ˜¯ä½ çš„è–ç¶“ï¼‰ï¼š\\n\" + $('Format Context').first().json.combinedContent.substring(0, 200000) }], response_format: { type: 'json_object' } }) }}"
      },
      "id": "llm-generate-detail",
      "name": "LLM: Worker Detail",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1300,
        100
      ],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst loopItems = $('Loop Modules').all();\nconst results = [];\n\n// Get existing tasks from context\nlet existingTasks = [];\ntry {\n    const formatContextNode = $('Format Context').first();\n    if (formatContextNode && formatContextNode.json && Array.isArray(formatContextNode.json.existingTasks)) {\n        existingTasks = formatContextNode.json.existingTasks;\n    }\n} catch(e) {}\n\n\nfor (let i = 0; i < items.length; i++) {\n    const item = items[i];\n    const loopItem = loopItems[i] || {};\n    const context = loopItem.json || {};\n\n    const validSourceIds = context.validSourceIds || [];\n\n    const content = item.json.choices?.[0]?.message?.content || '';\n    const clean = content.replace(/```json/g, '').replace(/```/g, '').trim();\n\n    let parsedObj = {};\n    try {\n        parsedObj = JSON.parse(clean);\n    } catch(e) {}\n\n    let finalText = '';\n    let parts = [];\n    if (Array.isArray(parsedObj)) {\n        parts = parsedObj.map(p => typeof p === 'string' ? p : p.requirement_text);\n    } else if (parsedObj.tasks && Array.isArray(parsedObj.tasks)) {\n        parts = parsedObj.tasks.map(t => t.requirement_text);\n    } else if (parsedObj.requirement_text) {\n        parts = [parsedObj.requirement_text];\n    }\n\n    finalText = parts.filter(Boolean).join('\\n\\n');\n    if (!finalText) continue;\n\n    // Prepend Module Name - FIXED: Use string concatenation to avoid SyntaxError\n    if (!finalText.includes(context.moduleName)) {\n        finalText = 'ã€' + context.moduleName + 'ã€‘å¯¦ä½œè¦æ ¼ï¼š\\n\\n' + finalText;\n    }\n\n    // Deduplication check - FIXED: Use string concatenation\n    const isDuplicate = existingTasks.some(existingText => {\n         return existingText.includes('ã€' + context.moduleName + 'ã€‘');\n    });\n\n    const getPageNum = (p) => {\n        const match = String(p).match(/\\d+/);\n        return match ? parseInt(match[0]) : null;\n    };\n\n    let citations = parsedObj.citations || [];\n    if (!Array.isArray(citations) && parsedObj.citation) {\n        citations = [parsedObj.citation];\n    }\n\n    const primary = citations[0] || {};\n    let primarySourceId = primary.source_id;\n\n    if (primarySourceId) {\n        const isValid = validSourceIds.includes(primarySourceId);\n        if (!isValid) {\n             const cleanId = primarySourceId.replace(/['\\\"]/g, '').trim();\n             if (validSourceIds.includes(cleanId)) {\n                 primarySourceId = cleanId;\n             } else {\n                 primarySourceId = null;\n             }\n        }\n    }\n\n    const primaryPage = getPageNum(primary.page);\n\n    if (!isDuplicate) {\n        results.push({\n            project_id: context.projectId,\n            section_id: context.sectionId,\n            requirement_text: finalText,\n            status: 'pending',\n            citation_source_id: primarySourceId,\n            citation_page: primaryPage,\n            citation_quote: primary.quote,\n            citations: citations\n        });\n        existingTasks.push(finalText);\n    }\n}\n\nreturn results.map(r => ({ json: r }));"
      },
      "id": "format-db-item",
      "name": "Format DB Item",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (items.length === 0) return [];\n\nconst firstItem = items.find(i => i.json.plan_mermaid || i.json.plan_architecture) || items[0];\nconst context = items[0].json;\n\n// Extract Plan Data\nconst additional = firstItem.json.plan_additional || [];\nconst actors = firstItem.json.plan_actors || [];\nconst mermaid = firstItem.json.plan_mermaid || '';\nconst arch = firstItem.json.plan_architecture || {};\n\nconst tasks = [];\n\n// 0. Dynamic Additional Sections (Replaces Hard-coded Concept)\nif (additional && Array.isArray(additional) && additional.length > 0) {\n    additional.forEach(section => {\n        if (section.title && section.content) {\n            tasks.push({\n                json: {\n                    project_id: context.projectId,\n                    section_id: context.sectionId,\n                    requirement_text: `ã€${section.title}ã€‘\\n\\n${section.content}`,\n                    status: 'pending'\n                }\n            });\n        }\n    });\n}\n\n// 1. User Flow Task (Mermaid)\nif (mermaid && mermaid.length > 5) {\n    let actorsText = '';\n    if (actors.length > 0) {\n        actorsText = `### 1. ç³»çµ±ä½¿ç”¨è€…è§’è‰² (Actors)\\n` + \n                     actors.map(a => `- ${a}`).join('\\n') + `\\n\\n`;\n    }\n\n    // Construct Mermaid Block\n    const mermaidBlock = `### 2. æ¥­å‹™æµç¨‹åœ– (User Flow)\\n\\n\\`\\`\\`mermaid\\n${mermaid}\\n\\`\\`\\``;\n\n    tasks.push({\n        json: {\n            project_id: context.projectId,\n            section_id: context.sectionId,\n            requirement_text: `ã€ä½¿ç”¨è€…æµç¨‹è¨­è¨ˆ (User Flow)ã€‘\\n\\n${actorsText}${mermaidBlock}`,\n            status: 'pending'\n        }\n    });\n}\n\n// 2. System Architecture Task (Frontend/Backend/SysAdmin Split)\nconst frontendPages = arch.frontend_pages || [];\nconst backendModules = arch.backend_modules || [];\nconst sysadminModules = arch.sysadmin_modules || [];\n\nif (frontendPages.length > 0 || backendModules.length > 0 || sysadminModules.length > 0) {\n    let archText = '';\n\n    const formatArchSection = (title, items) => {\n        if (!items || items.length === 0) return '';\n        let text = `### ${title}\\n`;\n        text += items.map((item, i) => {\n            // Handle both simple strings and detailed objects\n            if (typeof item === 'string') return `${i+1}. ${item}`;\n            \n            let line = `${i+1}. **${item.name}**`;\n            if (item.items && item.items.length > 0) {\n                // Use 'a. Item', 'b. Item' format\n                const subItems = item.items.map((sub, j) => {\n                    const bullet = String.fromCharCode(97 + j); // a, b, c...\n                    return `   ${bullet}. ${sub}`;\n                }).join('\\n');\n                line += `\\n${subItems}`;\n            }\n            return line;\n        }).join('\\n\\n'); // Extra newline for spacing between main items\n        return text + '\\n\\n';\n    };\n\n    // 1. Frontend Section\n    archText += formatArchSection('1. å‰å°æ¶æ§‹ (Frontend Pages)', frontendPages);\n\n    // 2. Backend Section\n    archText += formatArchSection('2. å¾Œå°æ¶æ§‹ (Backend Modules)', backendModules);\n\n    // 3. System Admin Section\n    archText += formatArchSection('3. ç³»çµ±ç®¡ç† (System Administration)', sysadminModules);\n\n    tasks.push({\n        json: {\n            project_id: context.projectId,\n            section_id: context.sectionId,\n            requirement_text: `ã€ç³»çµ±åŠŸèƒ½æ¶æ§‹ (System Architecture)ã€‘\\n\\n${archText}`,\n            status: 'pending'\n        }\n    });\n}\n\nreturn tasks;"
      },
      "id": "format-plan-tasks",
      "name": "Format Plan Tasks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        600
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Format Context').first().json.supabase_config.url + '/rest/v1/tasks' }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Format Context').first().json.supabase_config.service_key }}"
            },
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $('Format Context').first().json.supabase_config.service_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}"
      },
      "id": "insert-plan-db",
      "name": "Insert Plan DB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1300,
        600
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Format Context').first().json.supabase_config.url + '/rest/v1/tasks' }}",
        "authentication": "none",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $('Format Context').first().json.supabase_config.anon_key }}"
            },
            {
              "name": "Authorization",
              "value": "={{ 'Bearer ' + $('Format Context').first().json.supabase_config.service_key }}"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}"
      },
      "id": "insert-db",
      "name": "Insert DB",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1700,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "return { json: { result: 'done_background_processing' } };"
      },
      "id": "success",
      "name": "Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "return { \n    json: { \n        result: 'success', \n        message: 'Request received. Task generation started in background.', \n        timestamp: new Date().toISOString()\n    } \n};"
      },
      "id": "immediate-response",
      "name": "Immediate Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        500
      ]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ JSON.stringify({\"result\": \"success\", \"message\": \"Tasks generated via Manager-Worker loop\", \"total_modules\": $input.all().length }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "id": "response",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1500,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "// Restore the modules list for the Loop node\n// Logic: The original modules were output by 'Parse Modules'.\n// We simply retrieve them here.\nreturn $('Parse Modules').all();"
      },
      "id": "restore-data",
      "name": "Restore Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        600
      ]
    }
  ],
  "connections": {
    "Webhook: Generate Tasks": {
      "main": [
        [
          {
            "node": "Prepare Inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Inputs": {
      "main": [
        [
          {
            "node": "Immediate Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Context": {
      "main": [
        [
          {
            "node": "LLM: Plan Modules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM: Plan Modules": {
      "main": [
        [
          {
            "node": "Parse Modules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Modules": {
      "main": [
        [
          {
            "node": "Format Plan Tasks",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Modules": {
      "main": [
        [
          {
            "node": "Smart Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "LLM: Worker Detail": {
      "main": [
        [
          {
            "node": "Format DB Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format DB Item": {
      "main": [
        [
          {
            "node": "Insert DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert DB": {
      "main": [
        [
          {
            "node": "Loop Modules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Immediate Response": {
      "main": [
        [
          {
            "node": "Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Response": {
      "main": [
        [
          {
            "node": "Format Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Plan Tasks": {
      "main": [
        [
          {
            "node": "Insert Plan DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Plan DB": {
      "main": [
        [
          {
            "node": "Restore Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore Data": {
      "main": [
        [
          {
            "node": "Loop Modules",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Smart Router": {
      "main": [
        [
          {
            "node": "LLM: Worker Detail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}