# ðŸ” n8n å·¥ä½œæµåˆ†æžå ±å‘Š

**å·¥ä½œæµåç¨±**ï¼šTender Aggregation Workflow
**åˆ†æžæ™‚é–“**ï¼š2026-01-28

---

## ðŸ“‹ å·¥ä½œæµæž¶æ§‹

```
1. Webhook / Schedule Trigger
   â†“
2. Merge Triggers
   â†“
3. Get Subscriptionsï¼ˆå¾ž Supabase ç²å–è¨‚é–±é—œéµå­—ï¼‰
   â†“
4. Prepare Loop
   â†“
5. Search AceBidXï¼ˆæœå°‹æ¨™æ¡ˆåˆ—è¡¨ï¼‰
   â†“
6. Split Resultsï¼ˆæ‹†åˆ†çµæžœï¼‰
   â†“
7. Fetch Tender Pageï¼ˆæŠ“å–æ¨™æ¡ˆè©³ç´°é é¢ HTMLï¼‰â—
   â†“
8. Process Datesï¼ˆè™•ç†æ—¥æœŸå’Œç‹€æ…‹ï¼‰â—â—
   â†“
9. Save Tendersï¼ˆå„²å­˜åˆ° Supabaseï¼‰
```

---

## ðŸŽ¯ å•é¡Œæ ¸å¿ƒï¼šProcess Dates ç¯€é»ž

### **Deadline Date æå–é‚è¼¯**

```javascript
// æ­¥é©Ÿ 1ï¼šå˜—è©¦å¾ž API å›žæ‡‰ç²å–
let deadlineStr = originalItem.end_date;  // âŒ å•é¡Œæ‰€åœ¨ï¼

// æ­¥é©Ÿ 2ï¼šå¦‚æžœæ²’æœ‰ï¼Œå¾ž HTML ä¸­æå–
if (!deadlineStr && html) {
    const keywords = ['æˆªæ­¢æŠ•æ¨™', 'æˆªæ­¢'];  // â— é—œéµå­—å¯èƒ½ä¸å¤ 
    // ... æœå°‹é‚è¼¯
}
```

---

## ðŸš¨ ç™¼ç¾çš„å•é¡Œ

### **å•é¡Œ 1ï¼šAPI å›žæ‡‰æ²’æœ‰ end_date**

**è­‰æ“š**ï¼š
- `originalItem.end_date` é€šå¸¸æ˜¯ç©ºçš„
- AceBidX æœå°‹ API å›žå‚³çš„è³‡æ–™å¯èƒ½ä¸åŒ…å«æˆªæ­¢æ—¥æœŸ
- åªæœ‰æ¨™æ¡ˆåˆ—è¡¨ï¼Œæ²’æœ‰è©³ç´°è³‡è¨Š

**å½±éŸ¿**ï¼š
- ä¾è³´ HTML è§£æž
- ä½† HTML è§£æžé‚è¼¯æœ‰é™åˆ¶

---

### **å•é¡Œ 2ï¼šHTML è§£æžé™åˆ¶**

#### **2.1 é—œéµå­—ä¸è¶³**

```javascript
const keywords = ['æˆªæ­¢æŠ•æ¨™', 'æˆªæ­¢'];
```

**ç¼ºå°‘çš„é—œéµå­—**ï¼š
- "DEADLINE"ï¼ˆè‹±æ–‡ï¼‰
- "æŠ•æ¨™æˆªæ­¢"
- "æ”¶ä»¶æˆªæ­¢"
- "æˆªæ­¢æ™‚é–“"
- ç­‰ç­‰

**å¯¦éš›ç¶²ç«™ä¸Šçš„æ–‡å­—**ï¼š
- å¯èƒ½ä½¿ç”¨ "DEADLINE" æ¨™ç±¤
- ä¸åŒæ¨™æ¡ˆå¯èƒ½ç”¨ä¸åŒè©žå½™

---

#### **2.2 æœå°‹ç¯„åœé™åˆ¶**

```javascript
if (distance > 0 && distance < 3000 && distance < minDistance) {
    // åªæœå°‹é—œéµå­—å¾Œ 3000 å­—ç¬¦å…§
}
```

**å•é¡Œ**ï¼š
- å¦‚æžœ "DEADLINE" æ¨™ç±¤é›¢æ—¥æœŸå¤ªé ï¼ˆ> 3000 å­—ç¬¦ï¼‰ï¼Œæœƒæ‰¾ä¸åˆ°
- HTML çµæ§‹å¯èƒ½è®“æ—¥æœŸå‡ºç¾åœ¨é—œéµå­—ä¹‹å‰

---

#### **2.3 æ­£å‰‡è¡¨é”å¼ä¸å¤ ç²¾ç¢º**

```javascript
const dateRegex = /(\\d{2,3})[\\/.\\\\\]{1,2}(\\d{2})[\\/.\\\\\]{1,2}(\\d{2})(?:\\s+(\\d{1,2}:\\d{2}))?/g;
```

**å¯èƒ½çš„å•é¡Œ**ï¼š
- å¯èƒ½åŒ¹é…åˆ°éŒ¯èª¤çš„æ—¥æœŸï¼ˆå¦‚ç™¼å¸ƒæ—¥æœŸï¼‰
- ç„¡æ³•è™•ç†ç‰¹æ®Šæ ¼å¼

---

### **å•é¡Œ 3ï¼šonError è™•ç†**

```javascript
"onError": "continueErrorOutput"
```

**åœ¨ "Fetch Tender Page" ç¯€é»ž**

**å•é¡Œ**ï¼š
- å¦‚æžœæŠ“å– HTML å¤±æ•—ï¼Œæœƒç¹¼çºŒåŸ·è¡Œ
- ä½† `html` æœƒæ˜¯ç©ºçš„
- å°Žè‡´ç„¡æ³•å¾ž HTML æå– deadline

---

## ðŸ” å¯¦éš›æ¡ˆä¾‹åˆ†æž

### **å½°åŒ–ç¸£æ°¸é–é„‰è¡›ç”Ÿæ‰€æ¨™æ¡ˆ**

**ç¶²ç«™ HTML**ï¼š
```html
DEADLINE
æœªæä¾›    â† âŒ ç¶²ç«™ä¸Šé¡¯ç¤ºã€Œæœªæä¾›ã€ï¼
```

**ç­‰ç­‰ï¼è®“æˆ‘é‡æ–°æª¢æŸ¥ç¶²ç«™...**

å¾ž WebFetch çµæžœï¼š
```
æˆªæ­¢æ—¥æœŸ: 2026-01-22 09:00:00
```

**å¯¦éš›ä¸Šç¶²ç«™æœ‰æä¾›ï¼**

æ‰€ä»¥å•é¡Œæ˜¯ï¼š
1. n8n æŠ“å– HTML æ™‚ï¼Œæˆªæ­¢æ—¥æœŸå¯èƒ½é‚„æ²’è¼‰å…¥
2. æˆ–è€… HTML çµæ§‹è®“æ­£å‰‡è¡¨é”å¼æ‰¾ä¸åˆ°
3. æˆ–è€…é—œéµå­—ã€Œæˆªæ­¢ã€èˆ‡æ—¥æœŸè·é›¢å¤ªé 

---

## ðŸ’¡ æ ¹æœ¬åŽŸå› æŽ¨æ¸¬

### **åŽŸå›  1ï¼šJavaScript å‹•æ…‹è¼‰å…¥**

AceBidX å¯èƒ½ä½¿ç”¨ JavaScript å‹•æ…‹è¼‰å…¥æˆªæ­¢æ—¥æœŸï¼š

```
n8n HTTP Request æŠ“å– HTML
    â†“
åªæ‹¿åˆ°åˆå§‹ HTMLï¼ˆJavaScript æœªåŸ·è¡Œï¼‰
    â†“
æˆªæ­¢æ—¥æœŸåœ¨ JavaScript åŸ·è¡Œå¾Œæ‰å‡ºç¾
    â†“
n8n çœ‹åˆ°çš„ HTML æ²’æœ‰æˆªæ­¢æ—¥æœŸ
```

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- éœ€è¦ä½¿ç”¨ç€è¦½å™¨è‡ªå‹•åŒ–ï¼ˆPuppeteer/Playwrightï¼‰
- æˆ–ç›´æŽ¥èª¿ç”¨ AceBidX çš„ API

---

### **åŽŸå›  2ï¼šAPI ç«¯é»žä¸å®Œæ•´**

æœå°‹ APIï¼š
```
https://acebidx.com/api/search?query=...
```

**å›žå‚³çš„è³‡æ–™å¯èƒ½åªæœ‰**ï¼š
- æ¨™æ¡ˆæ¨™é¡Œ
- URL
- æ©Ÿé—œåç¨±
- âŒ æ²’æœ‰æˆªæ­¢æ—¥æœŸ

**éœ€è¦é¡å¤–çš„ API èª¿ç”¨**ï¼š
```
https://acebidx.com/api/tender/[ID]
```

ä¾†ç²å–å®Œæ•´è³‡æ–™ã€‚

---

## ðŸ› ï¸ è§£æ±ºæ–¹æ¡ˆ

### **æ–¹æ¡ˆ Aï¼šæ”¹é€² HTML è§£æžé‚è¼¯ï¼ˆéƒ¨åˆ†æœ‰æ•ˆï¼‰**

#### **1. æ“´å……é—œéµå­—**

```javascript
const keywords = [
    'æˆªæ­¢æŠ•æ¨™', 'æˆªæ­¢', 'æŠ•æ¨™æˆªæ­¢', 'æ”¶ä»¶æˆªæ­¢',
    'DEADLINE', 'deadline', 'æˆªæ­¢æ™‚é–“', 'æˆªæ­¢æ—¥æœŸ'
];
```

#### **2. å¢žåŠ æœå°‹ç¯„åœ**

```javascript
if (distance > 0 && distance < 5000 && distance < minDistance) {
    // å¢žåŠ åˆ° 5000 å­—ç¬¦
}
```

#### **3. æ”¹é€²æœå°‹é‚è¼¯**

```javascript
// åŒæ™‚å‘å‰å’Œå‘å¾Œæœå°‹
const forwardSearch = /* æœå°‹é—œéµå­—å¾Œçš„æ—¥æœŸ */;
const backwardSearch = /* æœå°‹é—œéµå­—å‰çš„æ—¥æœŸ */;
```

---

### **æ–¹æ¡ˆ Bï¼šä½¿ç”¨ç€è¦½å™¨è‡ªå‹•åŒ–ï¼ˆæœ€å¯é ï¼‰** â­

åœ¨ n8n ä¸­ä½¿ç”¨ Puppeteer ç¯€é»žï¼š

```
Fetch Tender Page (Puppeteer)
    â†“
ç­‰å¾…é é¢å®Œå…¨è¼‰å…¥
    â†“
åŸ·è¡Œ JavaScript
    â†“
æå–å®Œæ•´çš„ DOM è³‡æ–™
```

**å„ªé»ž**ï¼š
- å¯ä»¥è™•ç† JavaScript å‹•æ…‹è¼‰å…¥
- å¯ä»¥ç­‰å¾…ç‰¹å®šå…ƒç´ å‡ºç¾
- æå–æˆåŠŸçŽ‡é«˜

**ç¼ºé»ž**ï¼š
- åŸ·è¡Œè¼ƒæ…¢
- éœ€è¦é¡å¤–è³‡æº

---

### **æ–¹æ¡ˆ Cï¼šèª¿ç”¨ AceBidX APIï¼ˆæœ€é«˜æ•ˆï¼‰** â­â­â­

**æ­¥é©Ÿ 1ï¼šç¢ºèª AceBidX æœ‰è©³ç´°è³‡è¨Šçš„ API**

```
GET https://acebidx.com/api/tender/[tender_id]
```

**æ­¥é©Ÿ 2ï¼šä¿®æ”¹å·¥ä½œæµ**

```
Search AceBidX (åˆ—è¡¨)
    â†“
Split Results
    â†“
Loop: å°æ¯å€‹æ¨™æ¡ˆ
    â†“
    èª¿ç”¨è©³ç´° API (è€Œä¸æ˜¯æŠ“å– HTML)
    â†“
    æå– deadline_date
    â†“
Save Tenders
```

**å„ªé»ž**ï¼š
- æœ€å¿«
- æœ€å¯é 
- è³‡æ–™çµæ§‹åŒ–

---

### **æ–¹æ¡ˆ Dï¼šæ··åˆæ–¹æ¡ˆï¼ˆæŽ¨è–¦ï¼‰** â­â­

```javascript
// 1. å…ˆå˜—è©¦å¾žåˆ—è¡¨ API ç²å–
let deadlineStr = originalItem.end_date;

// 2. å¦‚æžœæ²’æœ‰ï¼Œèª¿ç”¨è©³ç´° API
if (!deadlineStr) {
    const tenderId = extractTenderId(originalItem.url);
    const detailApiResponse = await fetch(`https://acebidx.com/api/tender/${tenderId}`);
    deadlineStr = detailApiResponse.deadline;
}

// 3. æœ€å¾Œæ‰ç”¨ HTML è§£æžï¼ˆå‚™ç”¨ï¼‰
if (!deadlineStr && html) {
    // æ”¹é€²çš„ HTML è§£æžé‚è¼¯
}
```

---

## ðŸš€ å»ºè­°çš„ä¿®æ”¹æ­¥é©Ÿ

### **ç«‹å³ä¿®æ”¹ï¼ˆä»Šå¤©ï¼‰**

#### **Step 1ï¼šæ”¹é€²é—œéµå­—å’Œæœå°‹é‚è¼¯**

åœ¨ "Process Dates" ç¯€é»žä¸­ï¼š

```javascript
const keywords = [
    'æˆªæ­¢æŠ•æ¨™', 'æˆªæ­¢', 'æŠ•æ¨™æˆªæ­¢', 'æ”¶ä»¶æˆªæ­¢',
    'DEADLINE', 'deadline', 'æˆªæ­¢æ™‚é–“', 'æˆªæ­¢æ—¥æœŸ',
    'æŠ•æ¨™æœŸé™', 'æ”¶ä»¶æœŸé™'
];

// å¢žåŠ æœå°‹ç¯„åœ
if (distance > -1000 && distance < 5000 && Math.abs(distance) < minDistance) {
    // å‘å‰ 1000ã€å‘å¾Œ 5000 å­—ç¬¦
}
```

#### **Step 2ï¼šæ·»åŠ  Debug æ—¥èªŒ**

```javascript
console.log('Original end_date:', originalItem.end_date);
console.log('HTML length:', html ? html.length : 0);
console.log('Found deadline:', deadlineStr);
```

#### **Step 3ï¼šæ¸¬è©¦**

1. æ‰‹å‹•åŸ·è¡Œå·¥ä½œæµ
2. æŸ¥çœ‹åŸ·è¡Œæ—¥èªŒ
3. ç¢ºèª deadline_date æ˜¯å¦è¢«æå–

---

### **ä¸­æœŸæ”¹é€²ï¼ˆæœ¬é€±ï¼‰**

#### **æª¢æŸ¥ AceBidX æ˜¯å¦æœ‰è©³ç´°è³‡è¨Š API**

1. æŸ¥çœ‹ AceBidX çš„ API æ–‡æª”
2. æˆ–ç”¨ç€è¦½å™¨ DevTools ç›£æŽ§ç¶²è·¯è«‹æ±‚
3. æ‰¾åˆ°ç²å–æ¨™æ¡ˆè©³ç´°è³‡è¨Šçš„ API ç«¯é»ž

å¦‚æžœæœ‰ï¼š
- ä¿®æ”¹å·¥ä½œæµä½¿ç”¨ API
- ç§»é™¤ HTML æŠ“å–

---

### **é•·æœŸå„ªåŒ–ï¼ˆä¸‹é€±ï¼‰**

#### **è€ƒæ…®ä½¿ç”¨ Puppeteer**

å¦‚æžœ API ä¸å¯ç”¨ï¼š
- åœ¨ n8n ä¸­æ•´åˆ Puppeteer
- æˆ–å»ºç«‹ç¨ç«‹çš„ Edge Function ä¾†æŠ“å–è³‡æ–™

---

## ðŸ“Š é æœŸæ•ˆæžœ

### **ä¿®æ”¹å‰**
```
æœ‰ deadline_dateï¼š78 ç­†ï¼ˆ22.5%ï¼‰
ç„¡ deadline_dateï¼š268 ç­†ï¼ˆ77.5%ï¼‰
```

### **ä¿®æ”¹å¾Œï¼ˆæ”¹é€² HTML è§£æžï¼‰**
```
æœ‰ deadline_dateï¼š~200 ç­†ï¼ˆ~58%ï¼‰
ç„¡ deadline_dateï¼š~146 ç­†ï¼ˆ~42%ï¼‰
```

### **ä¿®æ”¹å¾Œï¼ˆä½¿ç”¨ APIï¼‰**
```
æœ‰ deadline_dateï¼š~300 ç­†ï¼ˆ~87%ï¼‰
ç„¡ deadline_dateï¼š~46 ç­†ï¼ˆ~13%ï¼‰
```

---

## ðŸŽ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

1. **æŸ¥çœ‹ n8n åŸ·è¡Œæ—¥èªŒ**
   - ç¢ºèªå¯¦éš›çš„éŒ¯èª¤å’Œè³‡æ–™
   - çœ‹çœ‹ HTML æ˜¯å¦æœ‰è¢«æŠ“å–

2. **æª¢æŸ¥ AceBidX API**
   - ç¢ºèªæ˜¯å¦æœ‰è©³ç´°è³‡è¨Šç«¯é»ž
   - æ¸¬è©¦ API å›žæ‡‰æ ¼å¼

3. **ä¿®æ”¹å·¥ä½œæµ**
   - æ ¹æ“šä¸Šè¿°åˆ†æžä¿®æ”¹ Process Dates ç¯€é»ž
   - æ¸¬è©¦ä¸¦é©—è­‰

éœ€è¦æˆ‘å”åŠ©åŸ·è¡Œå“ªä¸€æ­¥ï¼Ÿ
